# 2-3. ネスト可能なレイアウト

この章では、Next.jsのApp Routerにおけるネスト可能なレイアウトについて学びます。レイアウトを適切にネストすることで、共通UIを効率的に管理し、再利用性の高いアプリケーションを構築できるようになります。

---

## 目次

- [共通レイアウトの適用](#共通レイアウトの適用)
- [ネストされたレイアウトの挙動](#ネストされたレイアウトの挙動)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## 共通レイアウトの適用

### レイアウトとは
レイアウトは、**複数のページで共有されるUIコンポーネント**です。Next.jsのApp Routerでは、`layout.tsx`ファイルを使用してレイアウトを定義します。

### レイアウトの特徴
- **共有UI**: 複数のページで共通のUIを表示
- **状態の保持**: ナビゲーション時に状態が保持される
- **再レンダリングの最適化**: 変更されない部分のみ再レンダリング

### ルートレイアウト（app/layout.tsx）

ルートレイアウトは、**アプリケーション全体の共通レイアウト**です。すべてのページに適用されます。

#### 基本的なルートレイアウト

```tsx
// app/layout.tsx
import type { Metadata } from 'next'
import './globals.css'

export const metadata: Metadata = {
  title: 'My Next.js App',
  description: 'Next.jsアプリケーション',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <header>
          <h1>アプリケーションヘッダー</h1>
          <nav>
            <a href="/">ホーム</a>
            <a href="/about">About</a>
            <a href="/contact">Contact</a>
          </nav>
        </header>
        <main>{children}</main>
        <footer>
          <p>© 2024 My Next.js App</p>
        </footer>
      </body>
    </html>
  )
}
```

### 実践例: 共通レイアウトの適用

#### 1. ルートレイアウトの作成

```tsx
// app/layout.tsx
import type { Metadata } from 'next'
import Link from 'next/link'
import './globals.css'

export const metadata: Metadata = {
  title: 'My Next.js App',
  description: 'Next.jsアプリケーション',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <header className="header">
          <div className="container">
            <h1>My Next.js App</h1>
            <nav>
              <Link href="/">ホーム</Link>
              <Link href="/about">About</Link>
              <Link href="/contact">Contact</Link>
            </nav>
          </div>
        </header>
        <main className="main">{children}</main>
        <footer className="footer">
          <div className="container">
            <p>© 2024 My Next.js App</p>
          </div>
        </footer>
      </body>
    </html>
  )
}
```

#### 2. ページコンポーネントの作成

```tsx
// app/page.tsx
export default function Home() {
  return (
    <div className="page">
      <h1>ホームページ</h1>
      <p>Next.jsアプリケーションへようこそ</p>
    </div>
  )
}
```

```tsx
// app/about/page.tsx
export default function About() {
  return (
    <div className="page">
      <h1>Aboutページ</h1>
      <p>このページについて</p>
    </div>
  )
}
```

#### 3. グローバルスタイルの適用

```css
/* app/globals.css */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.header {
  background-color: #333;
  color: white;
  padding: 1rem 0;
}

.header nav {
  display: flex;
  gap: 1rem;
  margin-top: 0.5rem;
}

.header nav a {
  color: white;
  text-decoration: none;
}

.header nav a:hover {
  text-decoration: underline;
}

.main {
  min-height: calc(100vh - 200px);
  padding: 2rem 0;
}

.footer {
  background-color: #333;
  color: white;
  padding: 1rem 0;
  text-align: center;
}

.page {
  padding: 2rem;
}
```

### 実践例: 条件付きレイアウト要素

```tsx
// app/layout.tsx
import type { Metadata } from 'next'
import Link from 'next/link'
import { usePathname } from 'next/navigation'
import './globals.css'

export const metadata: Metadata = {
  title: 'My Next.js App',
  description: 'Next.jsアプリケーション',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <Header />
        <main className="main">{children}</main>
        <Footer />
      </body>
    </html>
  )
}

// ヘッダーコンポーネント
function Header() {
  return (
    <header className="header">
      <div className="container">
        <h1>My Next.js App</h1>
        <nav>
          <Link href="/">ホーム</Link>
          <Link href="/about">About</Link>
          <Link href="/contact">Contact</Link>
        </nav>
      </div>
    </header>
  )
}

// フッターコンポーネント
function Footer() {
  return (
    <footer className="footer">
      <div className="container">
        <p>© 2024 My Next.js App</p>
      </div>
    </footer>
  )
}
```

---

## ネストされたレイアウトの挙動

### ネストされたレイアウトとは
ネストされたレイアウトは、**特定のルートセグメントにのみ適用されるレイアウト**です。ルートレイアウトの内側に配置され、階層的にレイアウトを構築できます。

### レイアウトの階層構造

```
app/
├── layout.tsx              # ルートレイアウト（全ページに適用）
├── page.tsx                # ホームページ
├── about/
│   ├── layout.tsx          # Aboutセクションのレイアウト
│   ├── page.tsx            # Aboutページ
│   └── team/
│       ├── layout.tsx      # Teamセクションのレイアウト
│       └── page.tsx        # Teamページ
└── contact/
    └── page.tsx            # Contactページ
```

### レイアウトのネストの挙動

1. **ルートレイアウト**: すべてのページに適用
2. **セクションレイアウト**: そのセクションとその子セクションに適用
3. **子レイアウト**: さらに内側のセクションに適用

### 実践例: ネストされたレイアウトの実装

#### 1. ルートレイアウト

```tsx
// app/layout.tsx
import type { Metadata } from 'next'
import Link from 'next/link'
import './globals.css'

export const metadata: Metadata = {
  title: 'My Next.js App',
  description: 'Next.jsアプリケーション',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <header className="header">
          <div className="container">
            <h1>My Next.js App</h1>
            <nav>
              <Link href="/">ホーム</Link>
              <Link href="/about">About</Link>
              <Link href="/contact">Contact</Link>
            </nav>
          </div>
        </header>
        <main className="main">{children}</main>
        <footer className="footer">
          <div className="container">
            <p>© 2024 My Next.js App</p>
          </div>
        </footer>
      </body>
    </html>
  )
}
```

#### 2. Aboutセクションのレイアウト

```tsx
// app/about/layout.tsx
import Link from 'next/link'

export default function AboutLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="about-section">
      <aside className="sidebar">
        <nav>
          <h2>About</h2>
          <ul>
            <li>
              <Link href="/about">概要</Link>
            </li>
            <li>
              <Link href="/about/team">チーム</Link>
            </li>
            <li>
              <Link href="/about/history">歴史</Link>
            </li>
          </ul>
        </nav>
      </aside>
      <div className="content">{children}</div>
    </div>
  )
}
```

#### 3. Aboutページ

```tsx
// app/about/page.tsx
export default function About() {
  return (
    <div className="page">
      <h1>Aboutページ</h1>
      <p>このページについて</p>
    </div>
  )
}
```

#### 4. Teamセクションのレイアウト

```tsx
// app/about/team/layout.tsx
export default function TeamLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="team-section">
      <div className="team-header">
        <h2>チーム</h2>
        <p>私たちのチームメンバーを紹介します</p>
      </div>
      <div className="team-content">{children}</div>
    </div>
  )
}
```

#### 5. Teamページ

```tsx
// app/about/team/page.tsx
export default function Team() {
  return (
    <div className="page">
      <h1>チームメンバー</h1>
      <ul>
        <li>メンバー1</li>
        <li>メンバー2</li>
        <li>メンバー3</li>
      </ul>
    </div>
  )
}
```

#### 6. スタイルの追加

```css
/* app/globals.css */
/* ... 既存のスタイル ... */

.about-section {
  display: flex;
  gap: 2rem;
}

.sidebar {
  width: 200px;
  background-color: #f5f5f5;
  padding: 1rem;
  border-radius: 8px;
}

.sidebar nav ul {
  list-style: none;
  padding: 0;
}

.sidebar nav ul li {
  margin: 0.5rem 0;
}

.sidebar nav ul li a {
  color: #333;
  text-decoration: none;
}

.sidebar nav ul li a:hover {
  text-decoration: underline;
}

.content {
  flex: 1;
}

.team-section {
  padding: 1rem;
}

.team-header {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #333;
}

.team-content {
  padding: 1rem 0;
}
```

### レイアウトのレンダリング順序

レイアウトは、**外側から内側へ**順番にレンダリングされます。

```
ルートレイアウト (app/layout.tsx)
  └─ Aboutレイアウト (app/about/layout.tsx)
      └─ Teamレイアウト (app/about/team/layout.tsx)
          └─ Teamページ (app/about/team/page.tsx)
```

### 実践例: 複数セクションのレイアウト

#### 1. ダッシュボードセクションのレイアウト

```tsx
// app/dashboard/layout.tsx
import Link from 'next/link'

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="dashboard-section">
      <aside className="dashboard-sidebar">
        <nav>
          <h2>ダッシュボード</h2>
          <ul>
            <li>
              <Link href="/dashboard">概要</Link>
            </li>
            <li>
              <Link href="/dashboard/analytics">分析</Link>
            </li>
            <li>
              <Link href="/dashboard/settings">設定</Link>
            </li>
          </ul>
        </nav>
      </aside>
      <div className="dashboard-content">{children}</div>
    </div>
  )
}
```

#### 2. ダッシュボードページ

```tsx
// app/dashboard/page.tsx
export default function Dashboard() {
  return (
    <div className="page">
      <h1>ダッシュボード</h1>
      <p>ダッシュボードの概要を表示します</p>
    </div>
  )
}
```

### 実践例: 条件付きレイアウト要素（認証状態に応じた表示）

```tsx
// app/dashboard/layout.tsx
import Link from 'next/link'
import { getServerSession } from 'next-auth'
import { redirect } from 'next/navigation'

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const session = await getServerSession()

  if (!session) {
    redirect('/login')
  }

  return (
    <div className="dashboard-section">
      <aside className="dashboard-sidebar">
        <nav>
          <h2>ダッシュボード</h2>
          <ul>
            <li>
              <Link href="/dashboard">概要</Link>
            </li>
            <li>
              <Link href="/dashboard/analytics">分析</Link>
            </li>
            <li>
              <Link href="/dashboard/settings">設定</Link>
            </li>
          </ul>
        </nav>
        <div className="user-info">
          <p>ログイン中: {session.user?.email}</p>
        </div>
      </aside>
      <div className="dashboard-content">{children}</div>
    </div>
  )
}
```

### レイアウトの状態保持

レイアウトコンポーネントは、**ナビゲーション時に状態が保持される**という重要な特徴があります。

#### 実践例: 状態を保持するレイアウト

```tsx
// app/dashboard/layout.tsx
'use client'

import { useState } from 'react'
import Link from 'next/link'

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const [sidebarOpen, setSidebarOpen] = useState(true)

  return (
    <div className="dashboard-section">
      <aside className={`dashboard-sidebar ${sidebarOpen ? 'open' : 'closed'}`}>
        <button onClick={() => setSidebarOpen(!sidebarOpen)}>
          {sidebarOpen ? '閉じる' : '開く'}
        </button>
        <nav>
          <h2>ダッシュボード</h2>
          <ul>
            <li>
              <Link href="/dashboard">概要</Link>
            </li>
            <li>
              <Link href="/dashboard/analytics">分析</Link>
            </li>
            <li>
              <Link href="/dashboard/settings">設定</Link>
            </li>
          </ul>
        </nav>
      </aside>
      <div className="dashboard-content">{children}</div>
    </div>
  )
}
```

この例では、`sidebarOpen`の状態は、`/dashboard`から`/dashboard/analytics`に移動しても保持されます。

### 実践例: メタデータの継承と上書き

```tsx
// app/layout.tsx
import type { Metadata } from 'next'
import './globals.css'

export const metadata: Metadata = {
  title: {
    default: 'My Next.js App',
    template: '%s | My Next.js App',
  },
  description: 'Next.jsアプリケーション',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  )
}
```

```tsx
// app/about/layout.tsx
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'About',
  description: 'このページについて',
}

export default function AboutLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <div>{children}</div>
}
```

```tsx
// app/about/team/page.tsx
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'チーム',
  description: 'チームメンバーを紹介します',
}

export default function Team() {
  return (
    <div>
      <h1>チームメンバー</h1>
      <p>チームメンバーを紹介します</p>
    </div>
  )
}
```

この場合、`/about/team`ページのタイトルは「チーム | My Next.js App」になります。

---

## まとめ

この章では、Next.jsのApp Routerにおけるネスト可能なレイアウトについて学びました。

### 学んだこと
- 共通レイアウトの適用: ルートレイアウトで全ページに共通UIを適用
- ネストされたレイアウトの挙動: セクションごとにレイアウトを階層的に構築

### 重要なポイント
1. **ルートレイアウト**: `app/layout.tsx`で全ページに適用される共通レイアウト
2. **ネストされたレイアウト**: セクションごとに`layout.tsx`を作成して階層的に構築
3. **状態の保持**: レイアウトコンポーネントの状態はナビゲーション時に保持される
4. **レンダリング順序**: 外側から内側へ順番にレンダリングされる
5. **メタデータの継承**: 子レイアウトやページでメタデータを上書きできる

### 次のステップ
次の章では、Server Componentとレンダリングについて詳しく学びます。

---

## 演習問題

### 問題1: ルートレイアウトの作成
`app/layout.tsx`で、ヘッダー、メインコンテンツ、フッターを含むルートレイアウトを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/layout.tsx
import type { Metadata } from 'next'
import Link from 'next/link'
import './globals.css'

export const metadata: Metadata = {
  title: 'My Next.js App',
  description: 'Next.jsアプリケーション',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <header>
          <nav>
            <Link href="/">ホーム</Link>
            <Link href="/about">About</Link>
          </nav>
        </header>
        <main>{children}</main>
        <footer>
          <p>© 2024 My Next.js App</p>
        </footer>
      </body>
    </html>
  )
}
```
</details>

### 問題2: ネストされたレイアウトの作成
`app/blog/layout.tsx`で、ブログセクション専用のレイアウトを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/blog/layout.tsx
import Link from 'next/link'

export default function BlogLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="blog-section">
      <aside className="sidebar">
        <nav>
          <h2>ブログ</h2>
          <ul>
            <li>
              <Link href="/blog">一覧</Link>
            </li>
            <li>
              <Link href="/blog/categories">カテゴリー</Link>
            </li>
          </ul>
        </nav>
      </aside>
      <div className="content">{children}</div>
    </div>
  )
}
```
</details>

### 問題3: 複数階層のレイアウト
`app/blog/posts/layout.tsx`で、ブログ投稿セクション専用のレイアウトを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/blog/posts/layout.tsx
export default function PostsLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="posts-section">
      <div className="posts-header">
        <h2>投稿一覧</h2>
      </div>
      <div className="posts-content">{children}</div>
    </div>
  )
}
```
</details>

### 問題4: 状態を保持するレイアウト
`app/dashboard/layout.tsx`で、サイドバーの開閉状態を保持するレイアウトを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/dashboard/layout.tsx
'use client'

import { useState } from 'react'
import Link from 'next/link'

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const [sidebarOpen, setSidebarOpen] = useState(true)

  return (
    <div className="dashboard-section">
      <aside className={sidebarOpen ? 'open' : 'closed'}>
        <button onClick={() => setSidebarOpen(!sidebarOpen)}>
          {sidebarOpen ? '閉じる' : '開く'}
        </button>
        <nav>
          <h2>ダッシュボード</h2>
          <ul>
            <li>
              <Link href="/dashboard">概要</Link>
            </li>
            <li>
              <Link href="/dashboard/settings">設定</Link>
            </li>
          </ul>
        </nav>
      </aside>
      <div className="content">{children}</div>
    </div>
  )
}
```
</details>

### 問題5: メタデータの継承
`app/about/layout.tsx`で、メタデータを設定し、`app/about/team/page.tsx`で上書きしてください。

<details>
<summary>解答例</summary>

```tsx
// app/about/layout.tsx
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'About',
  description: 'このページについて',
}

export default function AboutLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <div>{children}</div>
}
```

```tsx
// app/about/team/page.tsx
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'チーム',
  description: 'チームメンバーを紹介します',
}

export default function Team() {
  return (
    <div>
      <h1>チームメンバー</h1>
    </div>
  )
}
```
</details>

---

お疲れ様でした！次の章に進みましょう。


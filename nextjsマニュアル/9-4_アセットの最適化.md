# 9-4. アセットの最適化

この章では、Next.jsにおけるアセット（画像、フォント、スクリプト）の最適化について学びます。Next.jsが提供する最適化されたコンポーネントを使用することで、パフォーマンスを向上させ、ユーザー体験を改善できるようになります。

---

## 目次

- [画像 (`next/image`)](#画像-nextimage)
- [フォント (`next/font`)](#フォント-nextfont)
- [スクリプト (`next/script`)](#スクリプト-nextscript)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## 画像 (`next/image`)

### next/imageとは
`next/image`は、**Next.jsが提供する最適化された画像コンポーネント**です。画像の自動最適化、遅延読み込み、レスポンシブ対応などの機能を提供します。

### next/imageの特徴
- **自動最適化**: WebP、AVIFなどの最新フォーマットへの自動変換
- **遅延読み込み**: ビューポートに入ったときに画像を読み込む
- **レスポンシブ**: デバイスに応じた適切なサイズの画像を配信
- **パフォーマンス**: 画像の最適化によりページ読み込み速度を向上

### 基本的な使用方法

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div>
      <Image
        src="/images/hero.jpg"
        alt="ヒーロー画像"
        width={800}
        height={600}
      />
    </div>
  )
}
```

### 実践例: 外部画像の使用

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div>
      <Image
        src="https://example.com/image.jpg"
        alt="外部画像"
        width={800}
        height={600}
      />
    </div>
  )
}
```

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'example.com',
        pathname: '/**',
      },
    ],
  },
}

module.exports = nextConfig
```

### 実践例: レスポンシブ画像

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div>
      <Image
        src="/images/hero.jpg"
        alt="ヒーロー画像"
        width={1200}
        height={800}
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
        style={{
          width: '100%',
          height: 'auto',
        }}
      />
    </div>
  )
}
```

### 実践例: 画像の優先読み込み

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div>
      {/* 優先読み込み（LCP画像など） */}
      <Image
        src="/images/hero.jpg"
        alt="ヒーロー画像"
        width={1200}
        height={800}
        priority
      />

      {/* 通常の画像（遅延読み込み） */}
      <Image
        src="/images/content.jpg"
        alt="コンテンツ画像"
        width={800}
        height={600}
      />
    </div>
  )
}
```

### 実践例: プレースホルダーの使用

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div>
      {/* ぼかしプレースホルダー */}
      <Image
        src="/images/hero.jpg"
        alt="ヒーロー画像"
        width={1200}
        height={800}
        placeholder="blur"
        blurDataURL="data:image/jpeg;base64,..."
      />
    </div>
  )
}
```

### 実践例: 画像の最適化設定

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    // 画像最適化の設定
    formats: ['image/avif', 'image/webp'],
    
    // デバイスサイズの設定
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    
    // 最小化の設定
    minimumCacheTTL: 60,
    
    // 外部画像のドメイン
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'example.com',
      },
    ],
  },
}

module.exports = nextConfig
```

### 実践例: 動的画像の読み込み

```tsx
// app/posts/[id]/page.tsx
import Image from 'next/image'

export default async function PostPage({
  params,
}: {
  params: { id: string }
}) {
  const post = await getPost(params.id)

  return (
    <div>
      <h1>{post.title}</h1>
      {post.imageUrl && (
        <Image
          src={post.imageUrl}
          alt={post.title}
          width={800}
          height={600}
        />
      )}
    </div>
  )
}
```

### 実践例: 画像のスタイリング

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div className="image-container">
      <Image
        src="/images/hero.jpg"
        alt="ヒーロー画像"
        width={1200}
        height={800}
        className="rounded-lg shadow-lg"
        style={{
          objectFit: 'cover',
        }}
      />
    </div>
  )
}
```

---

## フォント (`next/font`)

### next/fontとは
`next/font`は、**Next.jsが提供する最適化されたフォント読み込み機能**です。フォントの自動最適化、自己ホスト、ゼロレイアウトシフトなどの機能を提供します。

### next/fontの特徴
- **自動最適化**: フォントの自動最適化とサブセット化
- **自己ホスト**: フォントを自己ホストしてパフォーマンスを向上
- **ゼロレイアウトシフト**: フォント読み込み時のレイアウトシフトを防止
- **パフォーマンス**: フォント読み込みの最適化によりページ読み込み速度を向上

### 実践例: Google Fontsの使用

```tsx
// app/layout.tsx
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={inter.className}>
      <body>{children}</body>
    </html>
  )
}
```

### 実践例: 複数のフォントの使用

```tsx
// app/layout.tsx
import { Inter, Roboto_Mono } from 'next/font/google'
import './globals.css'

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
})

const robotoMono = Roboto_Mono({
  subsets: ['latin'],
  variable: '--font-roboto-mono',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={`${inter.variable} ${robotoMono.variable}`}>
      <body>{children}</body>
    </html>
  )
}
```

```css
/* app/globals.css */
body {
  font-family: var(--font-inter), sans-serif;
}

code {
  font-family: var(--font-roboto-mono), monospace;
}
```

### 実践例: カスタムフォントの使用

```tsx
// app/layout.tsx
import localFont from 'next/font/local'
import './globals.css'

const customFont = localFont({
  src: [
    {
      path: '../public/fonts/custom-regular.woff2',
      weight: '400',
      style: 'normal',
    },
    {
      path: '../public/fonts/custom-bold.woff2',
      weight: '700',
      style: 'normal',
    },
  ],
  variable: '--font-custom',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={customFont.variable}>
      <body>{children}</body>
    </html>
  )
}
```

### 実践例: フォントの最適化設定

```tsx
// app/layout.tsx
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({
  subsets: ['latin'],
  weight: ['400', '500', '600', '700'],
  display: 'swap', // フォント読み込み中の表示方法
  preload: true, // フォントの事前読み込み
  variable: '--font-inter',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={inter.variable}>
      <body>{children}</body>
    </html>
  )
}
```

### 実践例: フォントの条件付き読み込み

```tsx
// app/layout.tsx
import { Inter, Noto_Sans_JP } from 'next/font/google'
import './globals.css'

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
  display: 'swap',
})

const notoSansJP = Noto_Sans_JP({
  subsets: ['latin'],
  weight: ['400', '500', '700'],
  variable: '--font-noto-sans-jp',
  display: 'swap',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={`${inter.variable} ${notoSansJP.variable}`}>
      <body>{children}</body>
    </html>
  )
}
```

---

## スクリプト (`next/script`)

### next/scriptとは
`next/script`は、**Next.jsが提供する最適化されたスクリプト読み込みコンポーネント**です。スクリプトの読み込みタイミングを制御し、パフォーマンスを向上させます。

### next/scriptの特徴
- **読み込み戦略**: スクリプトの読み込みタイミングを制御
- **パフォーマンス**: スクリプト読み込みの最適化によりページ読み込み速度を向上
- **優先度制御**: スクリプトの読み込み優先度を制御

### 実践例: 基本的なスクリプトの読み込み

```tsx
// app/layout.tsx
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        {children}
        <Script src="https://example.com/script.js" />
      </body>
    </html>
  )
}
```

### 実践例: 読み込み戦略の指定

```tsx
// app/layout.tsx
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        {children}
        
        {/* beforeInteractive: ページがインタラクティブになる前に読み込む */}
        <Script
          src="https://example.com/critical.js"
          strategy="beforeInteractive"
        />
        
        {/* afterInteractive: ページがインタラクティブになった後に読み込む（デフォルト） */}
        <Script
          src="https://example.com/analytics.js"
          strategy="afterInteractive"
        />
        
        {/* lazyOnload: アイドル時間に読み込む */}
        <Script
          src="https://example.com/optional.js"
          strategy="lazyOnload"
        />
      </body>
    </html>
  )
}
```

### 実践例: インラインスクリプト

```tsx
// app/layout.tsx
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        {children}
        <Script id="inline-script" strategy="afterInteractive">
          {`
            console.log('Inline script executed');
            // インラインスクリプトのコード
          `}
        </Script>
      </body>
    </html>
  )
}
```

### 実践例: Google Analyticsの統合

```tsx
// app/layout.tsx
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        {children}
        <Script
          src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"
          strategy="afterInteractive"
        />
        <Script id="google-analytics" strategy="afterInteractive">
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'GA_MEASUREMENT_ID');
          `}
        </Script>
      </body>
    </html>
  )
}
```

### 実践例: スクリプトの条件付き読み込み

```tsx
// app/components/Analytics.tsx
'use client'

import Script from 'next/script'
import { useEffect, useState } from 'react'

export default function Analytics() {
  const [shouldLoad, setShouldLoad] = useState(false)

  useEffect(() => {
    // ユーザーの同意を得た後に読み込む
    const consent = localStorage.getItem('analytics-consent')
    if (consent === 'true') {
      setShouldLoad(true)
    }
  }, [])

  if (!shouldLoad) {
    return null
  }

  return (
    <Script
      src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"
      strategy="afterInteractive"
    />
  )
}
```

### 実践例: スクリプトのエラーハンドリング

```tsx
// app/layout.tsx
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        {children}
        <Script
          src="https://example.com/script.js"
          strategy="afterInteractive"
          onLoad={() => {
            console.log('Script loaded successfully')
          }}
          onError={(e) => {
            console.error('Script failed to load', e)
          }}
        />
      </body>
    </html>
  )
}
```

### 実践例: 複数のスクリプトの管理

```tsx
// app/layout.tsx
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        {children}
        
        {/* 分析ツール */}
        <Script
          src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"
          strategy="afterInteractive"
        />
        
        {/* チャットウィジェット */}
        <Script
          src="https://example.com/chat-widget.js"
          strategy="lazyOnload"
        />
        
        {/* ソーシャルメディア */}
        <Script
          src="https://platform.twitter.com/widgets.js"
          strategy="lazyOnload"
        />
      </body>
    </html>
  )
}
```

### 実践例: 動的スクリプトの読み込み

```tsx
// app/components/DynamicScript.tsx
'use client'

import Script from 'next/script'
import { useState } from 'react'

export default function DynamicScript() {
  const [loadScript, setLoadScript] = useState(false)

  return (
    <div>
      <button onClick={() => setLoadScript(true)}>
        スクリプトを読み込む
      </button>
      {loadScript && (
        <Script
          src="https://example.com/dynamic-script.js"
          strategy="lazyOnload"
        />
      )}
    </div>
  )
}
```

---

## まとめ

この章では、Next.jsにおけるアセット（画像、フォント、スクリプト）の最適化について学びました。

### 学んだこと
- 画像 (`next/image`): 画像の自動最適化とパフォーマンス向上
- フォント (`next/font`): フォントの最適化とゼロレイアウトシフト
- スクリプト (`next/script`): スクリプトの読み込み戦略とパフォーマンス最適化

### 重要なポイント
1. **next/image**: 自動最適化、遅延読み込み、レスポンシブ対応
2. **next/font**: 自動最適化、自己ホスト、ゼロレイアウトシフト
3. **next/script**: 読み込み戦略の制御、パフォーマンス最適化
4. **パフォーマンス**: アセットの最適化によりページ読み込み速度を向上
5. **ユーザー体験**: 最適化されたアセットによりユーザー体験を改善

### 次のステップ
次の章では、デプロイと運用について詳しく学びます。

---

## 演習問題

### 問題1: next/imageの使用
`next/image`を使用して、最適化された画像を表示してください。

<details>
<summary>解答例</summary>

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div>
      <Image
        src="/images/hero.jpg"
        alt="ヒーロー画像"
        width={1200}
        height={800}
        priority
      />
    </div>
  )
}
```
</details>

### 問題2: next/fontの使用
`next/font`を使用して、Google Fontsを読み込んでください。

<details>
<summary>解答例</summary>

```tsx
// app/layout.tsx
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={inter.className}>
      <body>{children}</body>
    </html>
  )
}
```
</details>

### 問題3: next/scriptの使用
`next/script`を使用して、Google Analyticsを統合してください。

<details>
<summary>解答例</summary>

```tsx
// app/layout.tsx
import Script from 'next/script'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        {children}
        <Script
          src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"
          strategy="afterInteractive"
        />
        <Script id="google-analytics" strategy="afterInteractive">
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'GA_MEASUREMENT_ID');
          `}
        </Script>
      </body>
    </html>
  )
}
```
</details>

### 問題4: レスポンシブ画像の実装
`next/image`を使用して、レスポンシブな画像を実装してください。

<details>
<summary>解答例</summary>

```tsx
// app/page.tsx
import Image from 'next/image'

export default function Home() {
  return (
    <div>
      <Image
        src="/images/hero.jpg"
        alt="ヒーロー画像"
        width={1200}
        height={800}
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
        style={{
          width: '100%',
          height: 'auto',
        }}
      />
    </div>
  )
}
```
</details>

### 問題5: 複数のフォントの使用
複数のフォントを使用して、異なる要素に異なるフォントを適用してください。

<details>
<summary>解答例</summary>

```tsx
// app/layout.tsx
import { Inter, Roboto_Mono } from 'next/font/google'
import './globals.css'

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
})

const robotoMono = Roboto_Mono({
  subsets: ['latin'],
  variable: '--font-roboto-mono',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja" className={`${inter.variable} ${robotoMono.variable}`}>
      <body>{children}</body>
    </html>
  )
}
```

```css
/* app/globals.css */
body {
  font-family: var(--font-inter), sans-serif;
}

code {
  font-family: var(--font-roboto-mono), monospace;
}
```
</details>

---

お疲れ様でした！次の章に進みましょう。


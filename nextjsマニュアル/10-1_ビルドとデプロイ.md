# 10-1. ビルドとデプロイ

この章では、Next.jsアプリケーションのビルドとデプロイについて学びます。ビルドプロセスの理解、Vercel等へのデプロイ方法、環境変数の管理など、本番環境へのデプロイに必要な知識を習得できるようになります。

---

## 目次

- [ビルドプロセスの理解](#ビルドプロセスの理解)
- [Vercel 等へのデプロイ](#vercel-等へのデプロイ)
- [環境変数の管理](#環境変数の管理)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## ビルドプロセスの理解

### ビルドとは
ビルドは、**Next.jsアプリケーションを本番環境で実行可能な形式に変換するプロセス**です。開発時のコードを最適化し、パフォーマンスを向上させます。

### ビルドプロセスの流れ

1. **依存関係のインストール**: `package.json`から依存関係をインストール
2. **TypeScriptのコンパイル**: TypeScriptファイルをJavaScriptに変換
3. **コードの最適化**: コードの最適化とバンドル
4. **静的生成**: 静的ページの事前レンダリング
5. **アセットの最適化**: 画像、フォント、CSSなどの最適化

### ビルドコマンド

```bash
# 本番環境用のビルド
npm run build

# ビルド結果のプレビュー
npm start
```

### ビルド出力の確認

```bash
# ビルドを実行
npm run build
```

ビルドが完了すると、以下のような出力が表示されます：

```
✓ Compiled successfully
✓ Linting and checking validity of types
✓ Collecting page data
✓ Generating static pages (X/X)
✓ Finalizing page optimization

Route (app)                              Size     First Load JS
┌ ○ /                                    X kB         Y kB
├ ○ /about                               X kB         Y kB
└ ○ /posts/[id]                          X kB         Y kB
```

### ビルド出力のディレクトリ構造

```
.next/
├── static/          # 静的アセット
├── server/          # サーバーサイドコード
├── cache/           # ビルドキャッシュ
└── BUILD_ID         # ビルドID
```

### 実践例: ビルドの最適化

#### 1. ビルド設定の確認

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 本番環境でのソースマップを無効化（セキュリティとパフォーマンス）
  productionBrowserSourceMaps: false,

  // 画像最適化の設定
  images: {
    domains: ['example.com'],
    formats: ['image/avif', 'image/webp'],
  },

  // 圧縮の設定
  compress: true,

  // 出力の設定
  output: 'standalone', // Docker等でのデプロイに最適
}

module.exports = nextConfig
```

#### 2. ビルドエラーの確認

```bash
# ビルドを実行してエラーを確認
npm run build

# TypeScriptの型チェックのみ実行
npx tsc --noEmit

# ESLintのチェックのみ実行
npm run lint
```

### 実践例: ビルド時間の最適化

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 実験的な機能を使用してビルド時間を短縮
  experimental: {
    // 並列ビルドの有効化
    parallelServerBuildTraces: true,
  },

  // Webpackの設定
  webpack: (config, { isServer }) => {
    if (!isServer) {
      // クライアント側のバンドルサイズを最適化
      config.optimization = {
        ...config.optimization,
        moduleIds: 'deterministic',
      }
    }
    return config
  },
}

module.exports = nextConfig
```

### 実践例: ビルド前のチェック

```json
// package.json
{
  "scripts": {
    "build": "next build",
    "build:check": "npm run lint && npm run type-check && npm run build",
    "type-check": "tsc --noEmit",
    "lint": "next lint"
  }
}
```

```bash
# ビルド前にすべてのチェックを実行
npm run build:check
```

---

## Vercel 等へのデプロイ

### Vercelとは
Vercelは、**Next.jsアプリケーションを最適化された環境にデプロイするためのプラットフォーム**です。Next.jsの開発元が提供しており、Next.jsアプリケーションに最適化されています。

### Vercelの特徴
- **自動デプロイ**: Gitリポジトリと連携して自動デプロイ
- **最適化**: Next.jsアプリケーションを自動的に最適化
- **スケーラビリティ**: 自動スケーリング
- **CDN**: グローバルCDNによる高速配信
- **環境変数管理**: 簡単な環境変数の管理

### Vercelへのデプロイ手順

#### 1. Vercelアカウントの作成

1. [Vercel](https://vercel.com)にアクセス
2. GitHub、GitLab、Bitbucketアカウントでサインアップ

#### 2. プロジェクトのインポート

1. Vercelダッシュボードで「New Project」をクリック
2. Gitリポジトリを選択
3. プロジェクト設定を確認

#### 3. 環境変数の設定

1. プロジェクト設定で「Environment Variables」を開く
2. 必要な環境変数を追加

#### 4. デプロイの実行

Vercelは自動的にデプロイを実行します。手動でデプロイする場合：

```bash
# Vercel CLIのインストール
npm i -g vercel

# デプロイ
vercel

# 本番環境へのデプロイ
vercel --prod
```

### 実践例: Vercel CLIを使用したデプロイ

```bash
# Vercel CLIのインストール
npm i -g vercel

# 初回デプロイ（対話形式）
vercel

# 本番環境へのデプロイ
vercel --prod

# プレビューデプロイ
vercel

# デプロイの確認
vercel ls
```

### 実践例: vercel.jsonの設定

```json
// vercel.json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["nrt1"], // 東京リージョン
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        }
      ]
    }
  ],
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "/api/:path*"
    }
  ]
}
```

### 実践例: その他のデプロイプラットフォーム

#### 1. Netlifyへのデプロイ

```bash
# Netlify CLIのインストール
npm i -g netlify-cli

# デプロイ
netlify deploy

# 本番環境へのデプロイ
netlify deploy --prod
```

```toml
# netlify.toml
[build]
  command = "npm run build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"
```

#### 2. AWS Amplifyへのデプロイ

```yaml
# amplify.yml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
```

#### 3. Dockerを使用したデプロイ

```dockerfile
# Dockerfile
FROM node:18-alpine AS base

# 依存関係のインストール
FROM base AS deps
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

# ビルド
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# 本番環境
FROM base AS runner
WORKDIR /app
ENV NODE_ENV production

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

```bash
# Dockerイメージのビルド
docker build -t my-nextjs-app .

# Dockerコンテナの実行
docker run -p 3000:3000 my-nextjs-app
```

### 実践例: CI/CDパイプラインの設定

#### GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

---

## 環境変数の管理

### 環境変数とは
環境変数は、**アプリケーションの設定や機密情報を管理するための変数**です。環境ごと（開発、ステージング、本番）に異なる値を設定できます。

### Next.jsでの環境変数の種類

1. **`.env.local`**: ローカル開発環境用（Gitにコミットしない）
2. **`.env.development`**: 開発環境用
3. **`.env.production`**: 本番環境用
4. **`.env`**: すべての環境で使用

### 環境変数の命名規則

- **`NEXT_PUBLIC_`プレフィックス**: クライアント側で使用可能な環境変数
- **プレフィックスなし**: サーバーサイドのみで使用可能

### 実践例: 環境変数の設定

#### 1. ローカル開発環境

```env
# .env.local
# データベース
DATABASE_URL="postgresql://user:password@localhost:5432/mydb"

# APIキー（サーバーサイドのみ）
API_KEY="your-api-key"

# クライアント側で使用可能
NEXT_PUBLIC_API_URL="http://localhost:3000/api"
NEXT_PUBLIC_APP_NAME="My App"
```

#### 2. 本番環境

```env
# .env.production
DATABASE_URL="postgresql://user:password@prod-db:5432/mydb"
API_KEY="production-api-key"
NEXT_PUBLIC_API_URL="https://api.example.com"
NEXT_PUBLIC_APP_NAME="My App"
```

### 実践例: 環境変数の型安全な使用

```typescript
// lib/env.ts
// 環境変数の型安全な取得

interface Env {
  databaseUrl: string
  apiKey: string
  apiUrl: string
  appName: string
}

function getEnv(): Env {
  const databaseUrl = process.env.DATABASE_URL
  const apiKey = process.env.API_KEY
  const apiUrl = process.env.NEXT_PUBLIC_API_URL
  const appName = process.env.NEXT_PUBLIC_APP_NAME

  if (!databaseUrl) {
    throw new Error('DATABASE_URL is not set')
  }

  if (!apiKey) {
    throw new Error('API_KEY is not set')
  }

  if (!apiUrl) {
    throw new Error('NEXT_PUBLIC_API_URL is not set')
  }

  if (!appName) {
    throw new Error('NEXT_PUBLIC_APP_NAME is not set')
  }

  return {
    databaseUrl,
    apiKey,
    apiUrl,
    appName,
  }
}

export const env = getEnv()
```

### 実践例: Vercelでの環境変数管理

#### 1. Vercelダッシュボードでの設定

1. プロジェクト設定で「Environment Variables」を開く
2. 環境変数を追加
3. 環境（Production、Preview、Development）を選択

#### 2. Vercel CLIでの設定

```bash
# 環境変数の追加
vercel env add DATABASE_URL production

# 環境変数の一覧表示
vercel env ls

# 環境変数の削除
vercel env rm DATABASE_URL production
```

### 実践例: 環境変数の検証

```typescript
// lib/env-validation.ts
// 環境変数の検証

const requiredEnvVars = [
  'DATABASE_URL',
  'API_KEY',
  'NEXT_PUBLIC_API_URL',
] as const

export function validateEnv() {
  const missing: string[] = []

  for (const envVar of requiredEnvVars) {
    if (!process.env[envVar]) {
      missing.push(envVar)
    }
  }

  if (missing.length > 0) {
    throw new Error(
      `Missing required environment variables: ${missing.join(', ')}`
    )
  }
}

// アプリケーション起動時に検証
validateEnv()
```

### 実践例: 環境変数の使用例

```typescript
// app/api/posts/route.ts
import { NextResponse } from 'next/server'

export async function GET() {
  // サーバーサイドでの環境変数の使用
  const apiKey = process.env.API_KEY

  const response = await fetch('https://api.example.com/posts', {
    headers: {
      'Authorization': `Bearer ${apiKey}`,
    },
  })

  const data = await response.json()
  return NextResponse.json(data)
}
```

```tsx
// app/page.tsx
'use client'

export default function Home() {
  // クライアント側での環境変数の使用（NEXT_PUBLIC_プレフィックスが必要）
  const apiUrl = process.env.NEXT_PUBLIC_API_URL

  return (
    <div>
      <h1>API URL: {apiUrl}</h1>
    </div>
  )
}
```

### 実践例: 環境変数のドキュメント化

```typescript
// .env.example
# データベース接続
DATABASE_URL="postgresql://user:password@localhost:5432/mydb"

# APIキー（サーバーサイドのみ）
API_KEY="your-api-key"

# クライアント側で使用可能
NEXT_PUBLIC_API_URL="http://localhost:3000/api"
NEXT_PUBLIC_APP_NAME="My App"
```

```markdown
# 環境変数の設定

## 必要な環境変数

- `DATABASE_URL`: データベース接続文字列
- `API_KEY`: 外部APIのキー（サーバーサイドのみ）
- `NEXT_PUBLIC_API_URL`: APIのベースURL（クライアント側で使用）
- `NEXT_PUBLIC_APP_NAME`: アプリケーション名（クライアント側で使用）

## 設定方法

1. `.env.example`を`.env.local`にコピー
2. 各環境変数に適切な値を設定
```

### 実践例: 環境ごとの設定

```typescript
// lib/config.ts
// 環境ごとの設定

const config = {
  development: {
    apiUrl: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000/api',
    databaseUrl: process.env.DATABASE_URL || 'postgresql://localhost:5432/dev',
  },
  production: {
    apiUrl: process.env.NEXT_PUBLIC_API_URL || 'https://api.example.com',
    databaseUrl: process.env.DATABASE_URL || '',
  },
  test: {
    apiUrl: 'http://localhost:3000/api',
    databaseUrl: 'postgresql://localhost:5432/test',
  },
}

export const appConfig = config[process.env.NODE_ENV || 'development']
```

---

## まとめ

この章では、Next.jsアプリケーションのビルドとデプロイについて学びました。

### 学んだこと
- ビルドプロセスの理解: Next.jsアプリケーションのビルドの流れと最適化
- Vercel等へのデプロイ: 様々なプラットフォームへのデプロイ方法
- 環境変数の管理: 環境変数の設定と管理方法

### 重要なポイント
1. **ビルドプロセス**: コードの最適化と静的生成
2. **Vercel**: Next.jsアプリケーションに最適化されたデプロイプラットフォーム
3. **環境変数**: `NEXT_PUBLIC_`プレフィックスでクライアント側で使用可能
4. **セキュリティ**: 機密情報はサーバーサイドのみで使用
5. **CI/CD**: 自動デプロイパイプラインの構築
6. **Docker**: コンテナ化によるデプロイ

### 次のステップ
これでNext.jsアプリケーションの開発からデプロイまでの一連の流れを理解できました。実際のプロジェクトでこれらの知識を活用してください。

---

## 演習問題

### 問題1: ビルドの実行
Next.jsアプリケーションをビルドし、ビルド結果を確認してください。

<details>
<summary>解答例</summary>

```bash
# ビルドの実行
npm run build

# ビルド結果の確認
ls -la .next

# ビルド結果のプレビュー
npm start
```
</details>

### 問題2: Vercelへのデプロイ
Vercel CLIを使用して、Next.jsアプリケーションをVercelにデプロイしてください。

<details>
<summary>解答例</summary>

```bash
# Vercel CLIのインストール
npm i -g vercel

# デプロイ
vercel

# 本番環境へのデプロイ
vercel --prod
```
</details>

### 問題3: 環境変数の設定
`.env.local`ファイルを作成し、必要な環境変数を設定してください。

<details>
<summary>解答例</summary>

```env
# .env.local
DATABASE_URL="postgresql://user:password@localhost:5432/mydb"
API_KEY="your-api-key"
NEXT_PUBLIC_API_URL="http://localhost:3000/api"
NEXT_PUBLIC_APP_NAME="My App"
```
</details>

### 問題4: 環境変数の型安全な使用
環境変数を型安全に取得する関数を作成してください。

<details>
<summary>解答例</summary>

```typescript
// lib/env.ts
interface Env {
  databaseUrl: string
  apiKey: string
  apiUrl: string
}

function getEnv(): Env {
  const databaseUrl = process.env.DATABASE_URL
  const apiKey = process.env.API_KEY
  const apiUrl = process.env.NEXT_PUBLIC_API_URL

  if (!databaseUrl || !apiKey || !apiUrl) {
    throw new Error('Missing required environment variables')
  }

  return {
    databaseUrl,
    apiKey,
    apiUrl,
  }
}

export const env = getEnv()
```
</details>

### 問題5: Dockerを使用したデプロイ
Dockerfileを作成し、Next.jsアプリケーションをDockerコンテナとして実行してください。

<details>
<summary>解答例</summary>

```dockerfile
# Dockerfile
FROM node:18-alpine AS base

FROM base AS deps
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

FROM base AS runner
WORKDIR /app
ENV NODE_ENV production

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

```bash
# Dockerイメージのビルド
docker build -t my-nextjs-app .

# Dockerコンテナの実行
docker run -p 3000:3000 my-nextjs-app
```
</details>

---

お疲れ様でした！Next.jsアプリケーションの開発からデプロイまでの一連の流れを理解できました。


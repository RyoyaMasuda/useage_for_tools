# 8-1. 認証機能（認証基盤の構築）

この章では、Next.jsアプリケーションで認証機能を実装するための基盤構築について学びます。NextAuth.js（Auth.js）を理解することで、OAuth認証やセッション管理を簡単に実装できるようになります。

---

## 目次

- [環境変数の設定](#環境変数の設定)
- [OAuthクライアントの作成 (Google, GitHub等)](#oauthクライアントの作成-google-github等)
- [NextAuth.js (Auth.js) の導入と設定](#nextauthjs-authjs-の導入と設定)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## 環境変数の設定

### 環境変数とは
環境変数は、**アプリケーションの設定情報を外部から注入する**仕組みです。機密情報や環境ごとに異なる設定を管理するために使用します。

### 日常生活での例
- **鍵**: 家の鍵（環境変数）を使って、家（アプリケーション）に入る
- **パスワード**: 銀行の暗証番号（環境変数）を使って、口座（アプリケーション）にアクセスする
- **IDカード**: 社員証（環境変数）を使って、オフィス（アプリケーション）に入る

### 環境変数の重要性
1. **セキュリティ**: 機密情報をコードに直接書かない
2. **環境ごとの設定**: 開発環境と本番環境で異なる設定を使用
3. **保守性**: 設定を一元管理できる

### Next.jsでの環境変数

```bash
# .env.local（ローカル開発環境用）
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here

# .env（全環境共通、Gitにコミット可能）
NEXT_PUBLIC_APP_NAME=My App
```

### 実践例: 基本的な環境変数の設定

```bash
# .env.local
# NextAuth.jsの設定
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here-minimum-32-characters-long

# OAuth設定（Google）
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# OAuth設定（GitHub）
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret

# データベース（Prisma使用時）
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
```

### 実践例: 環境変数の使用

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';

const handler = NextAuth({
    secret: process.env.NEXTAUTH_SECRET,
    // 環境変数を使用
});
```

### 実践例: 環境変数の検証

```tsx
// lib/env.ts
// 環境変数の検証と型安全な取得

const requiredEnvVars = {
    NEXTAUTH_URL: process.env.NEXTAUTH_URL,
    NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET,
    GOOGLE_CLIENT_ID: process.env.GOOGLE_CLIENT_ID,
    GOOGLE_CLIENT_SECRET: process.env.GOOGLE_CLIENT_SECRET,
} as const;

// 環境変数の検証
for (const [key, value] of Object.entries(requiredEnvVars)) {
    if (!value) {
        throw new Error(`環境変数 ${key} が設定されていません`);
    }
}

export const env = requiredEnvVars;
```

### 実践例: 本番環境での環境変数設定

```bash
# Vercelでの環境変数設定例
# Vercelのダッシュボードで設定するか、CLIで設定

# CLIでの設定
vercel env add NEXTAUTH_SECRET production
vercel env add GOOGLE_CLIENT_ID production
vercel env add GOOGLE_CLIENT_SECRET production
```

---

## OAuthクライアントの作成 (Google, GitHub等)

### OAuthとは
OAuthは、**サードパーティのサービス（Google、GitHubなど）で認証を行う**仕組みです。ユーザーは既存のアカウントでログインできます。

### 日常生活での例
- **会員カード**: 他の店の会員カード（OAuth）を使って、新しい店（アプリケーション）で会員登録する
- **連携サービス**: 銀行のアプリ（OAuth）を使って、他のサービス（アプリケーション）と連携する
- **シングルサインオン**: 一度ログイン（OAuth）すれば、複数のサービス（アプリケーション）を使える

### OAuthの流れ
1. ユーザーが「Googleでログイン」ボタンをクリック
2. Googleの認証画面にリダイレクト
3. ユーザーがGoogleで認証
4. Googleがアプリケーションに認証情報を返す
5. アプリケーションがユーザー情報を取得

### Google OAuthクライアントの作成

#### ステップ1: Google Cloud Consoleでプロジェクトを作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成
3. 「APIとサービス」→「認証情報」に移動
4. 「認証情報を作成」→「OAuth クライアント ID」を選択

#### ステップ2: OAuth同意画面の設定

1. 「OAuth同意画面」を設定
2. アプリケーション名、ユーザーサポートメールなどを入力
3. スコープを設定（必要に応じて）

#### ステップ3: OAuthクライアントIDの作成

1. アプリケーションの種類を選択（「ウェブアプリケーション」）
2. 承認済みのリダイレクトURIを設定
   - 開発環境: `http://localhost:3000/api/auth/callback/google`
   - 本番環境: `https://yourdomain.com/api/auth/callback/google`
3. クライアントIDとクライアントシークレットを取得

### 実践例: Google OAuthの設定

```bash
# .env.local
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret
```

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
    ],
});

export { handler as GET, handler as POST };
```

### GitHub OAuthクライアントの作成

#### ステップ1: GitHubでOAuth Appを作成

1. [GitHub Settings](https://github.com/settings/developers)にアクセス
2. 「OAuth Apps」→「New OAuth App」をクリック
3. アプリケーション情報を入力
   - Application name: アプリケーション名
   - Homepage URL: `http://localhost:3000`（開発環境）
   - Authorization callback URL: `http://localhost:3000/api/auth/callback/github`
4. 「Register application」をクリック

#### ステップ2: Client IDとClient Secretを取得

1. 作成したOAuth Appのページで、Client IDとClient Secretを確認
2. Client Secretは「Generate a new client secret」で生成

### 実践例: GitHub OAuthの設定

```bash
# .env.local
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
```

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GitHubProvider from 'next-auth/providers/github';

const handler = NextAuth({
    providers: [
        GitHubProvider({
            clientId: process.env.GITHUB_CLIENT_ID!,
            clientSecret: process.env.GITHUB_CLIENT_SECRET!,
        }),
    ],
});

export { handler as GET, handler as POST };
```

### 実践例: 複数のOAuthプロバイダー

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import GitHubProvider from 'next-auth/providers/github';

const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
        GitHubProvider({
            clientId: process.env.GITHUB_CLIENT_ID!,
            clientSecret: process.env.GITHUB_CLIENT_SECRET!,
        }),
    ],
});

export { handler as GET, handler as POST };
```

---

## NextAuth.js (Auth.js) の導入と設定

### NextAuth.jsとは
NextAuth.js（現在はAuth.js）は、**Next.jsアプリケーションで認証機能を簡単に実装するためのライブラリ**です。OAuth、Email、Credentialsなど、様々な認証方法をサポートしています。

### 日常生活での例
- **受付システム**: 受付システム（NextAuth.js）を使って、来客（ユーザー）を管理する
- **会員管理**: 会員管理システム（NextAuth.js）を使って、会員（ユーザー）を管理する
- **アクセス制御**: セキュリティシステム（NextAuth.js）を使って、入室（認証）を管理する

### NextAuth.jsの特徴
1. **簡単な設定**: 最小限の設定で認証機能を実装できる
2. **複数の認証方法**: OAuth、Email、Credentialsなどをサポート
3. **セッション管理**: セッションの管理が自動化される
4. **型安全性**: TypeScriptを完全サポート

### インストール

```bash
npm install next-auth
```

### 実践例: 基本的なNextAuth.jsの設定

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
    ],
    secret: process.env.NEXTAUTH_SECRET,
    pages: {
        signIn: '/auth/signin',
        error: '/auth/error',
    },
});

export { handler as GET, handler as POST };
```

### 実践例: セッション設定

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
    ],
    secret: process.env.NEXTAUTH_SECRET,
    session: {
        strategy: 'jwt', // または 'database'
        maxAge: 30 * 24 * 60 * 60, // 30日
    },
    callbacks: {
        async jwt({ token, user }) {
            if (user) {
                token.id = user.id;
            }
            return token;
        },
        async session({ session, token }) {
            if (session.user) {
                session.user.id = token.id as string;
            }
            return session;
        },
    },
});

export { handler as GET, handler as POST };
```

### 実践例: データベース連携（Prisma使用）

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import { PrismaAdapter } from '@auth/prisma-adapter';
import GoogleProvider from 'next-auth/providers/google';
import { prisma } from '@/lib/prisma';

const handler = NextAuth({
    adapter: PrismaAdapter(prisma),
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
    ],
    secret: process.env.NEXTAUTH_SECRET,
    callbacks: {
        async session({ session, user }) {
            if (session.user) {
                session.user.id = user.id;
            }
            return session;
        },
    },
});

export { handler as GET, handler as POST };
```

### 実践例: カスタムログインページ

```tsx
// app/auth/signin/page.tsx
'use client';

import { signIn } from 'next-auth/react';

export default function SignInPage() {
    return (
        <div style={{ maxWidth: '400px', margin: '0 auto', padding: '32px' }}>
            <h1>ログイン</h1>
            <button
                onClick={() => signIn('google')}
                style={{
                    width: '100%',
                    padding: '12px',
                    backgroundColor: '#4285f4',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    marginBottom: '8px',
                }}
            >
                Googleでログイン
            </button>
            <button
                onClick={() => signIn('github')}
                style={{
                    width: '100%',
                    padding: '12px',
                    backgroundColor: '#333',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer',
                }}
            >
                GitHubでログイン
            </button>
        </div>
    );
}
```

### 実践例: 型定義の拡張

```tsx
// types/next-auth.d.ts
import 'next-auth';

declare module 'next-auth' {
    interface Session {
        user: {
            id: string;
            name?: string | null;
            email?: string | null;
            image?: string | null;
        };
    }

    interface User {
        id: string;
    }
}

declare module 'next-auth/jwt' {
    interface JWT {
        id: string;
    }
}
```

### 実践例: 完全なNextAuth.js設定

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth, { type NextAuthOptions } from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import GitHubProvider from 'next-auth/providers/github';
import { PrismaAdapter } from '@auth/prisma-adapter';
import { prisma } from '@/lib/prisma';

export const authOptions: NextAuthOptions = {
    adapter: PrismaAdapter(prisma),
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
        GitHubProvider({
            clientId: process.env.GITHUB_CLIENT_ID!,
            clientSecret: process.env.GITHUB_CLIENT_SECRET!,
        }),
    ],
    secret: process.env.NEXTAUTH_SECRET,
    session: {
        strategy: 'jwt',
        maxAge: 30 * 24 * 60 * 60, // 30日
    },
    pages: {
        signIn: '/auth/signin',
        error: '/auth/error',
    },
    callbacks: {
        async jwt({ token, user, account }) {
            if (user) {
                token.id = user.id;
            }
            if (account) {
                token.accessToken = account.access_token;
            }
            return token;
        },
        async session({ session, token }) {
            if (session.user) {
                session.user.id = token.id as string;
            }
            return session;
        },
    },
    events: {
        async signIn({ user, account, profile }) {
            console.log('ユーザーがログインしました:', user.email);
        },
        async signOut({ session }) {
            console.log('ユーザーがログアウトしました');
        },
    },
};

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
```

### 実践例: セッション取得用のヘルパー関数

```tsx
// lib/auth.ts
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

export async function getSession() {
    return await getServerSession(authOptions);
}

export async function getCurrentUser() {
    const session = await getSession();
    return session?.user;
}
```

---

## まとめ

この章では、認証基盤の構築について以下のことを学びました。

### 環境変数の設定
- 環境変数は、アプリケーションの設定情報を外部から注入する仕組み
- `.env.local`に機密情報を設定し、`.env`に公開可能な設定を設定
- 環境変数の検証により、設定漏れを防ぐ
- 本番環境では、Vercelなどのプラットフォームで環境変数を設定

### OAuthクライアントの作成
- **Google OAuth**: Google Cloud ConsoleでOAuthクライアントを作成
- **GitHub OAuth**: GitHub SettingsでOAuth Appを作成
- リダイレクトURIを正しく設定することが重要
- クライアントIDとクライアントシークレットを環境変数に設定

### NextAuth.js (Auth.js) の導入と設定
- NextAuth.jsは、Next.jsアプリケーションで認証機能を簡単に実装するライブラリ
- `app/api/auth/[...nextauth]/route.ts`でNextAuth.jsを設定
- 複数のOAuthプロバイダーを同時に使用できる
- セッション管理、コールバック、イベントハンドラーをカスタマイズできる
- Prisma Adapterを使用して、データベースにセッションを保存できる

### 認証基盤の構築のメリット
- **セキュリティ**: OAuthを使用することで、安全な認証を実現
- **ユーザー体験**: 既存のアカウントでログインできるため、ユーザーが登録しやすい
- **保守性**: NextAuth.jsが認証処理を管理するため、保守が容易
- **拡張性**: 複数の認証方法を追加できる

### 次のステップ
認証基盤を構築したら、次のトピックに進みましょう：
- 認証とUIの連携（8-2）
- パフォーマンスとキャッシュの最適化（9章）

---

## 演習問題

以下の問題を解いて、認証基盤の構築の理解を深めましょう。

### 問題1: 環境変数の設定
NextAuth.jsに必要な環境変数を`.env.local`に設定してください。

<details>
<summary>解答例</summary>

```bash
# .env.local
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here-minimum-32-characters-long
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
```
</details>

### 問題2: Google OAuthクライアントの作成
Google Cloud ConsoleでOAuthクライアントを作成し、環境変数に設定してください。

<details>
<summary>解答例</summary>

1. Google Cloud Consoleでプロジェクトを作成
2. OAuth同意画面を設定
3. OAuthクライアントIDを作成
4. リダイレクトURIを設定: `http://localhost:3000/api/auth/callback/google`
5. クライアントIDとシークレットを`.env.local`に設定
</details>

### 問題3: NextAuth.jsの基本設定
Google OAuthを使用するNextAuth.jsの基本設定を作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
    ],
    secret: process.env.NEXTAUTH_SECRET,
});

export { handler as GET, handler as POST };
```
</details>

### 問題4: 複数のOAuthプロバイダー
GoogleとGitHubの両方のOAuthプロバイダーを設定してください。

<details>
<summary>解答例</summary>

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import GitHubProvider from 'next-auth/providers/github';

const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
        GitHubProvider({
            clientId: process.env.GITHUB_CLIENT_ID!,
            clientSecret: process.env.GITHUB_CLIENT_SECRET!,
        }),
    ],
    secret: process.env.NEXTAUTH_SECRET,
});

export { handler as GET, handler as POST };
```
</details>

### 問題5: セッション設定
JWT戦略を使用したセッション設定を実装してください。

<details>
<summary>解答例</summary>

```tsx
// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';

const handler = NextAuth({
    providers: [
        GoogleProvider({
            clientId: process.env.GOOGLE_CLIENT_ID!,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }),
    ],
    secret: process.env.NEXTAUTH_SECRET,
    session: {
        strategy: 'jwt',
        maxAge: 30 * 24 * 60 * 60, // 30日
    },
    callbacks: {
        async jwt({ token, user }) {
            if (user) {
                token.id = user.id;
            }
            return token;
        },
        async session({ session, token }) {
            if (session.user) {
                session.user.id = token.id as string;
            }
            return session;
        },
    },
});

export { handler as GET, handler as POST };
```
</details>

---

お疲れ様でした！次の章に進みましょう。


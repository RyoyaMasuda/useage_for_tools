# 8-2. 認証機能（認証とUIの連携）

この章では、NextAuth.jsで認証したユーザー情報をUIに表示し、ユーザーに応じた表示分岐を実装する方法について学びます。セッション管理と保護されたルートを理解することで、適切な認証機能を実装できるようになります。

---

## 目次

- [ログインユーザーのデータ表示 (Session管理)](#ログインユーザーのデータ表示-session管理)
- [閲覧ユーザーに応じた表示分岐 (保護されたルート、権限管理)](#閲覧ユーザーに応じた表示分岐-保護されたルート権限管理)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## ログインユーザーのデータ表示 (Session管理)

### セッションとは
セッションは、**ユーザーがログインしている状態を管理する**仕組みです。NextAuth.jsが自動的にセッションを管理し、ユーザー情報を取得できます。

### 日常生活での例
- **会員証**: 会員証（セッション）を見て、会員（ユーザー）の情報を確認する
- **入場券**: 入場券（セッション）を見て、来場者（ユーザー）の情報を確認する
- **IDカード**: IDカード（セッション）を見て、社員（ユーザー）の情報を確認する

### セッション管理の基本
1. **サーバーコンポーネント**: `getServerSession`を使用してセッションを取得
2. **クライアントコンポーネント**: `useSession`フックを使用してセッションを取得
3. **セッション情報**: ユーザー名、メールアドレス、画像などの情報を含む

### 実践例: サーバーコンポーネントでのセッション取得

```tsx
// lib/auth.ts
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

export async function getSession() {
    return await getServerSession(authOptions);
}

export async function getCurrentUser() {
    const session = await getSession();
    return session?.user;
}

// app/components/UserProfile.tsx
import { getCurrentUser } from '@/lib/auth';

export default async function UserProfile() {
    const user = await getCurrentUser();

    if (!user) {
        return <p>ログインしていません</p>;
    }

    return (
        <div>
            <h2>ユーザー情報</h2>
            {user.image && (
                <img 
                    src={user.image} 
                    alt={user.name || 'ユーザー'} 
                    style={{ width: '64px', height: '64px', borderRadius: '50%' }}
                />
            )}
            <p>名前: {user.name}</p>
            <p>メール: {user.email}</p>
        </div>
    );
}
```

### 実践例: クライアントコンポーネントでのセッション取得

```tsx
// app/components/ClientUserProfile.tsx
'use client';

import { useSession } from 'next-auth/react';

export default function ClientUserProfile() {
    const { data: session, status } = useSession();

    if (status === 'loading') {
        return <p>読み込み中...</p>;
    }

    if (status === 'unauthenticated') {
        return <p>ログインしていません</p>;
    }

    return (
        <div>
            <h2>ユーザー情報</h2>
            {session?.user?.image && (
                <img 
                    src={session.user.image} 
                    alt={session.user.name || 'ユーザー'} 
                    style={{ width: '64px', height: '64px', borderRadius: '50%' }}
                />
            )}
            <p>名前: {session?.user?.name}</p>
            <p>メール: {session?.user?.email}</p>
        </div>
    );
}
```

### 実践例: SessionProviderの設定

```tsx
// app/providers.tsx
'use client';

import { SessionProvider } from 'next-auth/react';

export function Providers({ children }: { children: React.ReactNode }) {
    return <SessionProvider>{children}</SessionProvider>;
}

// app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <html lang="ja">
            <body>
                <Providers>
                    {children}
                </Providers>
            </body>
        </html>
    );
}
```

### 実践例: ログイン・ログアウトボタン

```tsx
// app/components/AuthButton.tsx
'use client';

import { useSession, signIn, signOut } from 'next-auth/react';

export default function AuthButton() {
    const { data: session, status } = useSession();

    if (status === 'loading') {
        return <p>読み込み中...</p>;
    }

    if (session) {
        return (
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                <span>{session.user?.name}</span>
                <button
                    onClick={() => signOut()}
                    style={{
                        padding: '8px 16px',
                        backgroundColor: '#dc3545',
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer',
                    }}
                >
                    ログアウト
                </button>
            </div>
        );
    }

    return (
        <button
            onClick={() => signIn()}
            style={{
                padding: '8px 16px',
                backgroundColor: '#007bff',
                color: 'white',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
            }}
        >
            ログイン
        </button>
    );
}
```

### 実践例: ユーザー情報の表示

```tsx
// app/components/UserInfo.tsx
'use client';

import { useSession } from 'next-auth/react';

export default function UserInfo() {
    const { data: session } = useSession();

    if (!session?.user) {
        return null;
    }

    return (
        <div style={{
            padding: '16px',
            border: '1px solid #ddd',
            borderRadius: '8px',
            display: 'flex',
            alignItems: 'center',
            gap: '16px'
        }}>
            {session.user.image && (
                <img 
                    src={session.user.image} 
                    alt={session.user.name || 'ユーザー'} 
                    style={{ 
                        width: '48px', 
                        height: '48px', 
                        borderRadius: '50%' 
                    }}
                />
            )}
            <div>
                <p style={{ margin: 0, fontWeight: 'bold' }}>
                    {session.user.name || 'ユーザー'}
                </p>
                <p style={{ margin: 0, fontSize: '14px', color: '#666' }}>
                    {session.user.email}
                </p>
            </div>
        </div>
    );
}
```

### 実践例: ヘッダーでのセッション表示

```tsx
// app/components/Header.tsx
'use client';

import { useSession, signIn, signOut } from 'next-auth/react';
import Link from 'next/link';

export default function Header() {
    const { data: session, status } = useSession();

    return (
        <header style={{
            backgroundColor: '#333',
            color: '#fff',
            padding: '16px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
        }}>
            <div>
                <Link href="/" style={{ color: '#fff', textDecoration: 'none' }}>
                    My App
                </Link>
            </div>
            <nav style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                <Link href="/" style={{ color: '#fff', textDecoration: 'none' }}>
                    ホーム
                </Link>
                <Link href="/about" style={{ color: '#fff', textDecoration: 'none' }}>
                    About
                </Link>
                {status === 'loading' && <span>読み込み中...</span>}
                {status === 'authenticated' && (
                    <>
                        <span>{session?.user?.name}</span>
                        <button onClick={() => signOut()}>ログアウト</button>
                    </>
                )}
                {status === 'unauthenticated' && (
                    <button onClick={() => signIn()}>ログイン</button>
                )}
            </nav>
        </header>
    );
}
```

---

## 閲覧ユーザーに応じた表示分岐 (保護されたルート、権限管理)

### 保護されたルートとは
保護されたルートは、**認証が必要なページ**です。ログインしていないユーザーは、ログインページにリダイレクトされます。

### 日常生活での例
- **会員制の施設**: 会員（認証済みユーザー）のみが入れる施設（保護されたルート）
- **VIPルーム**: VIP会員（認証済みユーザー）のみが入れるルーム（保護されたルート）
- **管理エリア**: 管理者（認証済みユーザー）のみが入れるエリア（保護されたルート）

### 実践例: サーバーコンポーネントでの保護されたルート

```tsx
// app/dashboard/page.tsx
import { redirect } from 'next/navigation';
import { getSession } from '@/lib/auth';

export default async function DashboardPage() {
    const session = await getSession();

    // 認証されていない場合、ログインページにリダイレクト
    if (!session) {
        redirect('/auth/signin');
    }

    return (
        <div>
            <h1>ダッシュボード</h1>
            <p>ようこそ、{session.user?.name}さん</p>
        </div>
    );
}
```

### 実践例: ミドルウェアでの保護されたルート

```tsx
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { getToken } from 'next-auth/jwt';

export async function middleware(request: NextRequest) {
    const token = await getToken({ 
        req: request,
        secret: process.env.NEXTAUTH_SECRET 
    });

    // 保護されたルート
    const protectedPaths = ['/dashboard', '/admin', '/profile'];
    const isProtectedPath = protectedPaths.some(path => 
        request.nextUrl.pathname.startsWith(path)
    );

    // 認証が必要なページで、認証されていない場合
    if (isProtectedPath && !token) {
        const loginUrl = new URL('/auth/signin', request.url);
        loginUrl.searchParams.set('from', request.nextUrl.pathname);
        return NextResponse.redirect(loginUrl);
    }

    return NextResponse.next();
}

export const config = {
    matcher: ['/dashboard/:path*', '/admin/:path*', '/profile/:path*'],
};
```

### 実践例: クライアントコンポーネントでの保護されたルート

```tsx
// app/components/ProtectedContent.tsx
'use client';

import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export default function ProtectedContent({ children }: { children: React.ReactNode }) {
    const { data: session, status } = useSession();
    const router = useRouter();

    useEffect(() => {
        if (status === 'unauthenticated') {
            router.push('/auth/signin');
        }
    }, [status, router]);

    if (status === 'loading') {
        return <p>読み込み中...</p>;
    }

    if (status === 'unauthenticated') {
        return null;
    }

    return <>{children}</>;
}

// app/dashboard/page.tsx
import ProtectedContent from '@/components/ProtectedContent';

export default function DashboardPage() {
    return (
        <ProtectedContent>
            <div>
                <h1>ダッシュボード</h1>
                <p>このページは認証が必要です</p>
            </div>
        </ProtectedContent>
    );
}
```

### 実践例: 権限管理

```tsx
// lib/auth.ts
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

export async function getSession() {
    return await getServerSession(authOptions);
}

export async function getCurrentUser() {
    const session = await getSession();
    return session?.user;
}

export async function isAdmin() {
    const user = await getCurrentUser();
    // 実際のアプリケーションでは、データベースから権限を確認
    return user?.email === 'admin@example.com';
}

// app/admin/page.tsx
import { redirect } from 'next/navigation';
import { isAdmin } from '@/lib/auth';

export default async function AdminPage() {
    const admin = await isAdmin();

    // 管理者でない場合、ホームページにリダイレクト
    if (!admin) {
        redirect('/');
    }

    return (
        <div>
            <h1>管理画面</h1>
            <p>管理者専用ページです</p>
        </div>
    );
}
```

### 実践例: 条件付き表示

```tsx
// app/components/ConditionalContent.tsx
'use client';

import { useSession } from 'next-auth/react';

export default function ConditionalContent() {
    const { data: session } = useSession();

    return (
        <div>
            {session ? (
                <div>
                    <h2>ログイン済みユーザー向けコンテンツ</h2>
                    <p>ようこそ、{session.user?.name}さん</p>
                </div>
            ) : (
                <div>
                    <h2>ゲストユーザー向けコンテンツ</h2>
                    <p>ログインすると、より多くの機能が利用できます</p>
                </div>
            )}
        </div>
    );
}
```

### 実践例: ロールベースのアクセス制御

```tsx
// types/user.ts
export type UserRole = 'admin' | 'user' | 'guest';

// lib/auth.ts
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';
import { UserRole } from '@/types/user';

export async function getUserRole(): Promise<UserRole> {
    const session = await getServerSession(authOptions);
    
    if (!session?.user) {
        return 'guest';
    }

    // 実際のアプリケーションでは、データベースからロールを取得
    const userRoles: Record<string, UserRole> = {
        'admin@example.com': 'admin',
        'user@example.com': 'user',
    };

    return userRoles[session.user.email || ''] || 'user';
}

export async function hasRole(requiredRole: UserRole): Promise<boolean> {
    const userRole = await getUserRole();
    
    const roleHierarchy: Record<UserRole, number> = {
        guest: 0,
        user: 1,
        admin: 2,
    };

    return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
}

// app/components/RoleBasedContent.tsx
import { hasRole } from '@/lib/auth';
import { UserRole } from '@/types/user';

export default async function RoleBasedContent({ 
    requiredRole,
    children 
}: { 
    requiredRole: UserRole;
    children: React.ReactNode;
}) {
    const hasAccess = await hasRole(requiredRole);

    if (!hasAccess) {
        return (
            <div>
                <p>このコンテンツにアクセスする権限がありません</p>
            </div>
        );
    }

    return <>{children}</>;
}

// app/admin/page.tsx
import RoleBasedContent from '@/components/RoleBasedContent';

export default async function AdminPage() {
    return (
        <RoleBasedContent requiredRole="admin">
            <div>
                <h1>管理画面</h1>
                <p>管理者専用のコンテンツです</p>
            </div>
        </RoleBasedContent>
    );
}
```

### 実践例: クライアントコンポーネントでの権限管理

```tsx
// app/components/ClientRoleBasedContent.tsx
'use client';

import { useSession } from 'next-auth/react';
import { UserRole } from '@/types/user';

const userRoles: Record<string, UserRole> = {
    'admin@example.com': 'admin',
    'user@example.com': 'user',
};

function getUserRole(email?: string | null): UserRole {
    if (!email) return 'guest';
    return userRoles[email] || 'user';
}

function hasRole(userRole: UserRole, requiredRole: UserRole): boolean {
    const roleHierarchy: Record<UserRole, number> = {
        guest: 0,
        user: 1,
        admin: 2,
    };
    return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
}

export default function ClientRoleBasedContent({ 
    requiredRole,
    children 
}: { 
    requiredRole: UserRole;
    children: React.ReactNode;
}) {
    const { data: session } = useSession();
    const userRole = getUserRole(session?.user?.email);
    const hasAccess = hasRole(userRole, requiredRole);

    if (!hasAccess) {
        return (
            <div>
                <p>このコンテンツにアクセスする権限がありません</p>
            </div>
        );
    }

    return <>{children}</>;
}
```

### 実践例: ナビゲーションでの表示分岐

```tsx
// app/components/Navigation.tsx
'use client';

import { useSession, signIn, signOut } from 'next-auth/react';
import Link from 'next/link';

export default function Navigation() {
    const { data: session, status } = useSession();

    return (
        <nav style={{
            backgroundColor: '#333',
            color: '#fff',
            padding: '16px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
        }}>
            <div>
                <Link href="/" style={{ color: '#fff', textDecoration: 'none' }}>
                    My App
                </Link>
            </div>
            <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                <Link href="/" style={{ color: '#fff', textDecoration: 'none' }}>
                    ホーム
                </Link>
                <Link href="/about" style={{ color: '#fff', textDecoration: 'none' }}>
                    About
                </Link>
                
                {/* 認証済みユーザーのみ表示 */}
                {status === 'authenticated' && (
                    <>
                        <Link href="/dashboard" style={{ color: '#fff', textDecoration: 'none' }}>
                            ダッシュボード
                        </Link>
                        <Link href="/profile" style={{ color: '#fff', textDecoration: 'none' }}>
                            プロフィール
                        </Link>
                    </>
                )}

                {/* 管理者のみ表示 */}
                {status === 'authenticated' && session?.user?.email === 'admin@example.com' && (
                    <Link href="/admin" style={{ color: '#fff', textDecoration: 'none' }}>
                        管理画面
                    </Link>
                )}

                {status === 'authenticated' ? (
                    <button onClick={() => signOut()}>ログアウト</button>
                ) : (
                    <button onClick={() => signIn()}>ログイン</button>
                )}
            </div>
        </nav>
    );
}
```

### 実践例: 保護されたAPI Route

```tsx
// app/api/protected/route.ts
import { getServerSession } from 'next-auth';
import { authOptions } from '../auth/[...nextauth]/route';
import { NextResponse } from 'next/server';

export async function GET() {
    const session = await getServerSession(authOptions);

    if (!session) {
        return NextResponse.json(
            { error: '認証が必要です' },
            { status: 401 }
        );
    }

    return NextResponse.json({
        message: '保護されたデータ',
        user: session.user,
    });
}
```

---

## まとめ

この章では、認証とUIの連携について以下のことを学びました。

### ログインユーザーのデータ表示 (Session管理)
- **サーバーコンポーネント**: `getServerSession`を使用してセッションを取得
- **クライアントコンポーネント**: `useSession`フックを使用してセッションを取得
- **SessionProvider**: クライアントコンポーネントでセッションを使用するために必要
- **ユーザー情報の表示**: セッションからユーザー名、メールアドレス、画像などを取得して表示

### 閲覧ユーザーに応じた表示分岐 (保護されたルート、権限管理)
- **保護されたルート**: 認証が必要なページを実装
- **サーバーコンポーネント**: `redirect`を使用してリダイレクト
- **ミドルウェア**: 複数のルートを一括で保護
- **クライアントコンポーネント**: `useSession`と`useRouter`を使用して保護
- **権限管理**: ロールベースのアクセス制御を実装
- **条件付き表示**: 認証状態に応じてコンテンツを表示

### 認証とUIの連携のメリット
- **セキュリティ**: 認証が必要なページを保護できる
- **ユーザー体験**: 認証状態に応じた適切なUIを表示できる
- **権限管理**: ロールベースのアクセス制御を実装できる
- **保守性**: 認証ロジックを一元管理できる

### 次のステップ
認証とUIの連携を理解したら、次のトピックに進みましょう：
- パフォーマンスとキャッシュの最適化（9章）
- デプロイと運用（10章）

---

## 演習問題

以下の問題を解いて、認証とUIの連携の理解を深めましょう。

### 問題1: セッション情報の表示
ログインユーザーの名前とメールアドレスを表示するコンポーネントを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/components/UserInfo.tsx
'use client';

import { useSession } from 'next-auth/react';

export default function UserInfo() {
    const { data: session } = useSession();

    if (!session?.user) {
        return <p>ログインしていません</p>;
    }

    return (
        <div>
            <p>名前: {session.user.name}</p>
            <p>メール: {session.user.email}</p>
        </div>
    );
}
```
</details>

### 問題2: 保護されたルート
認証が必要なダッシュボードページを作成し、認証されていない場合はログインページにリダイレクトしてください。

<details>
<summary>解答例</summary>

```tsx
// app/dashboard/page.tsx
import { redirect } from 'next/navigation';
import { getSession } from '@/lib/auth';

export default async function DashboardPage() {
    const session = await getSession();

    if (!session) {
        redirect('/auth/signin');
    }

    return (
        <div>
            <h1>ダッシュボード</h1>
            <p>ようこそ、{session.user?.name}さん</p>
        </div>
    );
}
```
</details>

### 問題3: ログイン・ログアウトボタン
ログイン状態に応じて、ログインボタンまたはログアウトボタンを表示するコンポーネントを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/components/AuthButton.tsx
'use client';

import { useSession, signIn, signOut } from 'next-auth/react';

export default function AuthButton() {
    const { data: session } = useSession();

    if (session) {
        return <button onClick={() => signOut()}>ログアウト</button>;
    }

    return <button onClick={() => signIn()}>ログイン</button>;
}
```
</details>

### 問題4: 条件付き表示
認証状態に応じて、異なるコンテンツを表示するコンポーネントを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/components/ConditionalContent.tsx
'use client';

import { useSession } from 'next-auth/react';

export default function ConditionalContent() {
    const { data: session } = useSession();

    return (
        <div>
            {session ? (
                <p>ログイン済みユーザー向けコンテンツ</p>
            ) : (
                <p>ゲストユーザー向けコンテンツ</p>
            )}
        </div>
    );
}
```
</details>

### 問題5: 管理者専用ページ
管理者のみがアクセスできるページを作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/admin/page.tsx
import { redirect } from 'next/navigation';
import { getSession } from '@/lib/auth';

export default async function AdminPage() {
    const session = await getSession();

    if (!session) {
        redirect('/auth/signin');
    }

    // 管理者チェック
    if (session.user?.email !== 'admin@example.com') {
        redirect('/');
    }

    return (
        <div>
            <h1>管理画面</h1>
            <p>管理者専用ページです</p>
        </div>
    );
}
```
</details>

---

お疲れ様でした！次の章に進みましょう。


# 2-1. ファイルシステムベースルーティング

この章では、Next.jsのファイルシステムベースルーティングについて学びます。ファイルやフォルダの構造でルーティングが自動的に生成される仕組みを理解することで、効率的にNext.jsアプリケーションを開発できるようになります。

---

## 目次

- [Segment構成ファイル (page.tsx, layout.tsx, template.tsx 等)](#segment構成ファイル-pagetsx-layouttsx-templatetsx-等)
- [Segment構成フォルダ (Route Groups, Dynamic Routes)](#segment構成フォルダ-route-groups-dynamic-routes)
- [アプリケーションのルーティング定義](#アプリケーションのルーティング定義)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## Segment構成ファイル (page.tsx, layout.tsx, template.tsx 等)

### ファイルシステムベースルーティングとは
ファイルシステムベースルーティングは、**ファイルやフォルダの構造に基づいてルーティングが自動的に生成される**仕組みです。Next.jsのApp Routerでは、`app`ディレクトリ内のファイル構造がそのままURL構造になります。

### 日常生活での例
- **本の目次**: 本の章立て（ファイル構造）がそのまま目次（ルーティング）になる
- **住所**: 住所の階層（都道府県→市区町村→番地）がそのままルーティングになる
- **会社の組織図**: 部署の階層構造がそのままルーティングになる

### 基本的なファイル構造

```
app/
├── page.tsx          → / (ルート)
├── about/
│   └── page.tsx      → /about
├── contact/
│   └── page.tsx      → /contact
└── blog/
    └── page.tsx      → /blog
```

### page.tsx

`page.tsx`は、**そのルートで表示されるページコンポーネント**です。各ルートには必ず`page.tsx`が必要です。

```tsx
// app/page.tsx
export default function Home() {
    return <h1>ホームページ</h1>;
}

// app/about/page.tsx
export default function About() {
    return <h1>Aboutページ</h1>;
}
```

### layout.tsx

`layout.tsx`は、**そのルートと子ルートに共通のレイアウトを提供する**コンポーネントです。複数のページで共通のUI（ヘッダー、フッターなど）を定義します。

```tsx
// app/layout.tsx
export default function RootLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <html lang="ja">
            <body>
                <header>ヘッダー</header>
                {children}
                <footer>フッター</footer>
            </body>
        </html>
    );
}

// app/blog/layout.tsx
export default function BlogLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div>
            <h1>ブログ</h1>
            {children}
        </div>
    );
}
```

### template.tsx

`template.tsx`は、**レイアウトに似ているが、ナビゲーション時に毎回新しいインスタンスが作成される**コンポーネントです。アニメーションや状態管理が必要な場合に使用します。

```tsx
// app/template.tsx
'use client';

import { useState } from 'react';

export default function Template({
    children,
}: {
    children: React.ReactNode;
}) {
    const [count, setCount] = useState(0);
    
    return (
        <div>
            <p>テンプレート: {count}</p>
            <button onClick={() => setCount(count + 1)}>カウントアップ</button>
            {children}
        </div>
    );
}
```

### loading.tsx

`loading.tsx`は、**そのルートと子ルートのローディング状態を表示する**コンポーネントです。

```tsx
// app/loading.tsx
export default function Loading() {
    return <div>読み込み中...</div>;
}

// app/blog/loading.tsx
export default function BlogLoading() {
    return <div>ブログを読み込み中...</div>;
}
```

### error.tsx

`error.tsx`は、**そのルートと子ルートでエラーが発生したときに表示される**コンポーネントです。

```tsx
// app/error.tsx
'use client';

export default function Error({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    return (
        <div>
            <h2>エラーが発生しました</h2>
            <p>{error.message}</p>
            <button onClick={reset}>再試行</button>
        </div>
    );
}
```

### not-found.tsx

`not-found.tsx`は、**404ページを表示する**コンポーネントです。

```tsx
// app/not-found.tsx
export default function NotFound() {
    return (
        <div>
            <h2>ページが見つかりません</h2>
            <p>お探しのページは存在しません。</p>
        </div>
    );
}
```

### 実践例: Segment構成ファイル

```tsx
// app/layout.tsx
import './globals.css';

export const metadata = {
    title: 'My App',
    description: 'Next.jsアプリケーション',
};

export default function RootLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <html lang="ja">
            <body>
                <header>
                    <nav>
                        <a href="/">ホーム</a>
                        <a href="/about">About</a>
                        <a href="/blog">ブログ</a>
                    </nav>
                </header>
                <main>{children}</main>
                <footer>
                    <p>&copy; 2024 My App</p>
                </footer>
            </body>
        </html>
    );
}

// app/page.tsx
export default function Home() {
    return (
        <div>
            <h1>ホームページ</h1>
            <p>ようこそ！</p>
        </div>
    );
}

// app/about/page.tsx
export default function About() {
    return (
        <div>
            <h1>About</h1>
            <p>このアプリケーションについて</p>
        </div>
    );
}

// app/about/layout.tsx
export default function AboutLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div>
            <h2>Aboutセクション</h2>
            {children}
        </div>
    );
}

// app/blog/page.tsx
export default function Blog() {
    return (
        <div>
            <h1>ブログ</h1>
            <ul>
                <li><a href="/blog/post-1">投稿1</a></li>
                <li><a href="/blog/post-2">投稿2</a></li>
            </ul>
        </div>
    );
}

// app/blog/layout.tsx
export default function BlogLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div>
            <aside>
                <h3>カテゴリー</h3>
                <ul>
                    <li>技術</li>
                    <li>日記</li>
                </ul>
            </aside>
            <main>{children}</main>
        </div>
    );
}

// app/blog/loading.tsx
export default function BlogLoading() {
    return (
        <div>
            <p>ブログを読み込み中...</p>
        </div>
    );
}

// app/blog/error.tsx
'use client';

export default function BlogError({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    return (
        <div>
            <h2>ブログの読み込みに失敗しました</h2>
            <p>{error.message}</p>
            <button onClick={reset}>再試行</button>
        </div>
    );
}

// app/not-found.tsx
export default function NotFound() {
    return (
        <div>
            <h2>404 - ページが見つかりません</h2>
            <p>お探しのページは存在しません。</p>
            <a href="/">ホームに戻る</a>
        </div>
    );
}
```

---

## Segment構成フォルダ (Route Groups, Dynamic Routes)

### Route Groups（ルートグループ）

Route Groupsは、**URLには影響せず、フォルダを整理するための機能**です。`(groupName)`という形式でフォルダ名を囲むと、そのフォルダ名はURLに含まれません。

#### Route Groupsの基本

```
app/
├── (marketing)/
│   ├── about/
│   │   └── page.tsx      → /about
│   └── contact/
│       └── page.tsx      → /contact
└── (shop)/
    ├── products/
    │   └── page.tsx      → /products
    └── cart/
        └── page.tsx      → /cart
```

#### Route Groupsの実践例

```tsx
// app/(marketing)/about/page.tsx
export default function About() {
    return <h1>About</h1>;
}

// app/(marketing)/contact/page.tsx
export default function Contact() {
    return <h1>Contact</h1>;
}

// app/(shop)/products/page.tsx
export default function Products() {
    return <h1>Products</h1>;
}

// app/(shop)/cart/page.tsx
export default function Cart() {
    return <h1>Cart</h1>;
}

// app/(marketing)/layout.tsx
export default function MarketingLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div>
            <nav>マーケティングナビゲーション</nav>
            {children}
        </div>
    );
}

// app/(shop)/layout.tsx
export default function ShopLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div>
            <nav>ショップナビゲーション</nav>
            {children}
        </div>
    );
}
```

### Dynamic Routes（動的ルート）

Dynamic Routesは、**URLパラメータを受け取るルート**です。フォルダ名を`[paramName]`という形式にすると、その部分が動的パラメータになります。

#### Dynamic Routesの基本

```
app/
├── blog/
│   ├── [slug]/
│   │   └── page.tsx      → /blog/:slug
│   └── [category]/
│       └── [slug]/
│           └── page.tsx  → /blog/:category/:slug
```

#### Dynamic Routesの実践例

```tsx
// app/blog/[slug]/page.tsx
interface BlogPostProps {
    params: {
        slug: string;
    };
}

export default async function BlogPost({ params }: BlogPostProps) {
    const { slug } = params;
    
    // データ取得（実際の実装ではAPIやデータベースから取得）
    const post = await getPostBySlug(slug);
    
    if (!post) {
        notFound();
    }
    
    return (
        <div>
            <h1>{post.title}</h1>
            <p>{post.content}</p>
        </div>
    );
}

// app/blog/[category]/[slug]/page.tsx
interface CategoryPostProps {
    params: {
        category: string;
        slug: string;
    };
}

export default async function CategoryPost({ params }: CategoryPostProps) {
    const { category, slug } = params;
    
    const post = await getPostByCategoryAndSlug(category, slug);
    
    if (!post) {
        notFound();
    }
    
    return (
        <div>
            <h1>{post.title}</h1>
            <p>カテゴリー: {category}</p>
            <p>{post.content}</p>
        </div>
    );
}
```

### Catch-all Routes（キャッチオールルート）

Catch-all Routesは、**複数のセグメントをキャッチするルート**です。`[...paramName]`という形式でフォルダ名を定義します。

```
app/
└── docs/
    └── [...slug]/
        └── page.tsx      → /docs/* (すべてのパス)
```

```tsx
// app/docs/[...slug]/page.tsx
interface DocsProps {
    params: {
        slug: string[];
    };
}

export default function Docs({ params }: DocsProps) {
    const { slug } = params;
    
    return (
        <div>
            <h1>ドキュメント</h1>
            <p>パス: /docs/{slug.join('/')}</p>
        </div>
    );
}

// /docs → slug = []
// /docs/getting-started → slug = ['getting-started']
// /docs/getting-started/installation → slug = ['getting-started', 'installation']
```

### Optional Catch-all Routes（オプショナルキャッチオールルート）

Optional Catch-all Routesは、**0個以上のセグメントをキャッチするルート**です。`[[...paramName]]`という形式でフォルダ名を定義します。

```
app/
└── shop/
    └── [[...slug]]/
        └── page.tsx      → /shop または /shop/*
```

```tsx
// app/shop/[[...slug]]/page.tsx
interface ShopProps {
    params: {
        slug?: string[];
    };
}

export default function Shop({ params }: ShopProps) {
    const { slug } = params;
    
    if (!slug || slug.length === 0) {
        return <div>ショップホーム</div>;
    }
    
    return (
        <div>
            <h1>ショップ</h1>
            <p>パス: /shop/{slug.join('/')}</p>
        </div>
    );
}

// /shop → slug = undefined
// /shop/category → slug = ['category']
// /shop/category/product → slug = ['category', 'product']
```

### 実践例: Segment構成フォルダ

```tsx
// app/(auth)/login/page.tsx
export default function Login() {
    return (
        <div>
            <h1>ログイン</h1>
            <form>
                <input type="email" placeholder="メールアドレス" />
                <input type="password" placeholder="パスワード" />
                <button type="submit">ログイン</button>
            </form>
        </div>
    );
}

// app/(auth)/register/page.tsx
export default function Register() {
    return (
        <div>
            <h1>登録</h1>
            <form>
                <input type="text" placeholder="名前" />
                <input type="email" placeholder="メールアドレス" />
                <input type="password" placeholder="パスワード" />
                <button type="submit">登録</button>
            </form>
        </div>
    );
}

// app/(auth)/layout.tsx
export default function AuthLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div className="auth-layout">
            <div className="auth-container">
                {children}
            </div>
        </div>
    );
}

// app/users/[id]/page.tsx
interface UserProps {
    params: {
        id: string;
    };
}

export default async function User({ params }: UserProps) {
    const { id } = params;
    const user = await getUserById(id);
    
    if (!user) {
        notFound();
    }
    
    return (
        <div>
            <h1>{user.name}</h1>
            <p>ID: {id}</p>
            <p>メール: {user.email}</p>
        </div>
    );
}

// app/users/[id]/posts/[postId]/page.tsx
interface UserPostProps {
    params: {
        id: string;
        postId: string;
    };
}

export default async function UserPost({ params }: UserPostProps) {
    const { id, postId } = params;
    const post = await getUserPost(id, postId);
    
    if (!post) {
        notFound();
    }
    
    return (
        <div>
            <h1>{post.title}</h1>
            <p>ユーザーID: {id}</p>
            <p>投稿ID: {postId}</p>
            <p>{post.content}</p>
        </div>
    );
}
```

---

## アプリケーションのルーティング定義

### ルーティングの基本原則

1. **ファイル構造 = URL構造**: `app`ディレクトリ内のファイル構造がそのままURLになる
2. **page.tsxが必要**: 各ルートには`page.tsx`が必要
3. **フォルダ名がURL**: フォルダ名がURLのパスになる
4. **特殊ファイル**: `layout.tsx`、`loading.tsx`、`error.tsx`などは特殊な役割を持つ

### ルーティングの階層構造

```
app/
├── page.tsx                    → /
├── about/
│   └── page.tsx                → /about
├── blog/
│   ├── page.tsx                → /blog
│   ├── layout.tsx              → レイアウト
│   ├── [slug]/
│   │   └── page.tsx            → /blog/:slug
│   └── [category]/
│       └── [slug]/
│           └── page.tsx        → /blog/:category/:slug
├── (auth)/
│   ├── login/
│   │   └── page.tsx            → /login
│   └── register/
│       └── page.tsx            → /register
└── shop/
    ├── page.tsx                → /shop
    └── [[...slug]]/
        └── page.tsx            → /shop または /shop/*
```

### 実践例: アプリケーションのルーティング定義

```tsx
// app/layout.tsx（ルートレイアウト）
import './globals.css';

export const metadata = {
    title: 'My Next.js App',
    description: 'Next.jsアプリケーション',
};

export default function RootLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <html lang="ja">
            <body>
                <header>
                    <nav>
                        <a href="/">ホーム</a>
                        <a href="/about">About</a>
                        <a href="/blog">ブログ</a>
                        <a href="/shop">ショップ</a>
                    </nav>
                </header>
                <main>{children}</main>
                <footer>
                    <p>&copy; 2024 My App</p>
                </footer>
            </body>
        </html>
    );
}

// app/page.tsx（ホームページ）
export default function Home() {
    return (
        <div>
            <h1>ホームページ</h1>
            <p>ようこそ！</p>
        </div>
    );
}

// app/about/page.tsx
export default function About() {
    return (
        <div>
            <h1>About</h1>
            <p>このアプリケーションについて</p>
        </div>
    );
}

// app/blog/page.tsx（ブログ一覧）
export default async function Blog() {
    const posts = await getPosts();
    
    return (
        <div>
            <h1>ブログ</h1>
            <ul>
                {posts.map(post => (
                    <li key={post.id}>
                        <a href={`/blog/${post.slug}`}>{post.title}</a>
                    </li>
                ))}
            </ul>
        </div>
    );
}

// app/blog/layout.tsx（ブログレイアウト）
export default function BlogLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div className="blog-layout">
            <aside>
                <h3>カテゴリー</h3>
                <ul>
                    <li><a href="/blog/tech">技術</a></li>
                    <li><a href="/blog/diary">日記</a></li>
                </ul>
            </aside>
            <main>{children}</main>
        </div>
    );
}

// app/blog/[slug]/page.tsx（ブログ投稿）
interface BlogPostProps {
    params: {
        slug: string;
    };
}

export default async function BlogPost({ params }: BlogPostProps) {
    const { slug } = params;
    const post = await getPostBySlug(slug);
    
    if (!post) {
        notFound();
    }
    
    return (
        <article>
            <h1>{post.title}</h1>
            <p>{post.date}</p>
            <div>{post.content}</div>
        </article>
    );
}

// app/blog/[category]/[slug]/page.tsx（カテゴリー別ブログ投稿）
interface CategoryPostProps {
    params: {
        category: string;
        slug: string;
    };
}

export default async function CategoryPost({ params }: CategoryPostProps) {
    const { category, slug } = params;
    const post = await getPostByCategoryAndSlug(category, slug);
    
    if (!post) {
        notFound();
    }
    
    return (
        <article>
            <p>カテゴリー: {category}</p>
            <h1>{post.title}</h1>
            <div>{post.content}</div>
        </article>
    );
}

// app/shop/page.tsx（ショップホーム）
export default function Shop() {
    return (
        <div>
            <h1>ショップ</h1>
            <p>商品一覧</p>
        </div>
    );
}

// app/shop/[[...slug]]/page.tsx（ショップの動的ルート）
interface ShopProps {
    params: {
        slug?: string[];
    };
}

export default function ShopPage({ params }: ShopProps) {
    const { slug } = params;
    
    if (!slug || slug.length === 0) {
        return <div>ショップホーム</div>;
    }
    
    if (slug.length === 1) {
        // /shop/category
        return <div>カテゴリー: {slug[0]}</div>;
    }
    
    if (slug.length === 2) {
        // /shop/category/product
        return (
            <div>
                <p>カテゴリー: {slug[0]}</p>
                <p>商品: {slug[1]}</p>
            </div>
        );
    }
    
    return <div>その他のパス</div>;
}

// app/(auth)/login/page.tsx
export default function Login() {
    return (
        <div>
            <h1>ログイン</h1>
            <form>
                <input type="email" placeholder="メールアドレス" />
                <input type="password" placeholder="パスワード" />
                <button type="submit">ログイン</button>
            </form>
        </div>
    );
}

// app/(auth)/register/page.tsx
export default function Register() {
    return (
        <div>
            <h1>登録</h1>
            <form>
                <input type="text" placeholder="名前" />
                <input type="email" placeholder="メールアドレス" />
                <input type="password" placeholder="パスワード" />
                <button type="submit">登録</button>
            </form>
        </div>
    );
}

// app/(auth)/layout.tsx
export default function AuthLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div className="auth-layout">
            <div className="auth-container">
                {children}
            </div>
        </div>
    );
}
```

### ルーティングのベストプラクティス

1. **明確な構造**: フォルダ構造を明確にして、ルーティングを理解しやすくする
2. **Route Groupsの活用**: 関連するルートをグループ化して整理
3. **レイアウトの階層化**: 必要な階層でレイアウトを定義
4. **動的ルートの命名**: 動的パラメータには意味のある名前を付ける
5. **エラーハンドリング**: 各階層で適切にエラーハンドリングを行う

---

## まとめ

この章では、Next.jsのファイルシステムベースルーティングについて学びました。

### 学んだこと
- **Segment構成ファイル**: page.tsx、layout.tsx、template.tsx、loading.tsx、error.tsx、not-found.tsx
- **Route Groups**: フォルダを整理するための機能（URLには影響しない）
- **Dynamic Routes**: URLパラメータを受け取る動的ルート
- **Catch-all Routes**: 複数のセグメントをキャッチするルート
- **ルーティング定義**: ファイル構造がそのままURL構造になる

### 重要なポイント
1. **page.tsx**: 各ルートに必要なファイル
2. **layout.tsx**: 共通レイアウトを提供
3. **Route Groups**: `(groupName)`でフォルダを整理
4. **Dynamic Routes**: `[paramName]`で動的パラメータを受け取る
5. **ファイル構造 = URL構造**: appディレクトリ内の構造がそのままURLになる

### 使い分けの目安
- **page.tsx**: ページコンポーネント
- **layout.tsx**: 共通レイアウト
- **Route Groups**: フォルダの整理
- **Dynamic Routes**: 動的なパラメータが必要な場合

### 次のステップ
ファイルシステムベースルーティングを理解することで、Next.jsアプリケーションの構造を効率的に設計できるようになります。次の章では、SPAならではのナビゲーションについて詳しく学びます。

---

## 演習問題

### 問題1: 基本的なページの作成
`app/about/page.tsx`を作成し、Aboutページを表示してください。

<details>
<summary>解答例</summary>

```tsx
// app/about/page.tsx
export default function About() {
    return (
        <div>
            <h1>About</h1>
            <p>このアプリケーションについて</p>
        </div>
    );
}
```
</details>

### 問題2: レイアウトの作成
`app/blog/layout.tsx`を作成し、ブログセクションに共通のレイアウトを適用してください。

<details>
<summary>解答例</summary>

```tsx
// app/blog/layout.tsx
export default function BlogLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div>
            <h1>ブログ</h1>
            {children}
        </div>
    );
}
```
</details>

### 問題3: 動的ルートの作成
`app/users/[id]/page.tsx`を作成し、ユーザーIDを受け取って表示してください。

<details>
<summary>解答例</summary>

```tsx
// app/users/[id]/page.tsx
interface UserProps {
    params: {
        id: string;
    };
}

export default function User({ params }: UserProps) {
    const { id } = params;
    
    return (
        <div>
            <h1>ユーザー</h1>
            <p>ID: {id}</p>
        </div>
    );
}
```
</details>

### 問題4: Route Groupsの使用
Route Groupsを使って、認証関連のページ（login、register）を整理してください。

<details>
<summary>解答例</summary>

```tsx
// app/(auth)/login/page.tsx
export default function Login() {
    return <h1>ログイン</h1>;
}

// app/(auth)/register/page.tsx
export default function Register() {
    return <h1>登録</h1>;
}

// app/(auth)/layout.tsx
export default function AuthLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div className="auth-layout">
            {children}
        </div>
    );
}
```
</details>

### 問題5: Catch-all Routesの使用
Catch-all Routesを使って、`app/docs/[...slug]/page.tsx`を作成してください。

<details>
<summary>解答例</summary>

```tsx
// app/docs/[...slug]/page.tsx
interface DocsProps {
    params: {
        slug: string[];
    };
}

export default function Docs({ params }: DocsProps) {
    const { slug } = params;
    
    return (
        <div>
            <h1>ドキュメント</h1>
            <p>パス: /docs/{slug.join('/')}</p>
        </div>
    );
}
```
</details>

---

お疲れ様でした！次の章に進みましょう。


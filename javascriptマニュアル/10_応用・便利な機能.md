# 10. 応用・便利な機能

この章では、JavaScriptの応用的な機能と便利な組み込みオブジェクトについて学びます。これらの機能を理解することで、より効率的にプログラムを作成できるようになります。

---

## 目次

- [JSON - データをやり取りする共通言語](#json---データをやり取りする共通言語)
- [エラーハンドリング - try...catch文](#エラーハンドリング---trycatch文)
- [便利な組み込みオブジェクト (Math, Date, Map, Set)](#便利な組み込みオブジェクト-math-date-map-set)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## JSON - データをやり取りする共通言語

### JSONとは
JSON（JavaScript Object Notation）は、**データを表現するための形式**です。JavaScriptオブジェクトと似た構文で、様々なプログラミング言語で使われます。

### JSONの特徴
1. **テキスト形式**: 人間が読める形式
2. **軽量**: XMLなどより軽量
3. **汎用性**: 様々な言語で使える
4. **データ交換**: サーバーとクライアント間でデータをやり取りするのに適している

### JSONの基本構文

```json
{
    "name": "太郎",
    "age": 25,
    "city": "東京"
}
```

### JSONとJavaScriptオブジェクトの違い

| 項目 | JSON | JavaScriptオブジェクト |
|------|------|----------------------|
| **キー** | 必ずダブルクォート | クォート不要 |
| **値** | 文字列、数値、真偽値、null、配列、オブジェクトのみ | 関数なども可能 |
| **コメント** | 不可 | 可能 |

### JSONの変換

#### JSON.stringify() - オブジェクトをJSON文字列に変換
```javascript
const obj = { name: '太郎', age: 25 };
const json = JSON.stringify(obj);
console.log(json); // '{"name":"太郎","age":25}'
```

#### JSON.parse() - JSON文字列をオブジェクトに変換
```javascript
const json = '{"name":"太郎","age":25}';
const obj = JSON.parse(json);
console.log(obj.name); // '太郎'
```

### 実践例: JSON

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JSON - データをやり取りする共通言語</title>
</head>
<body>
    <h1>JSON - データをやり取りする共通言語</h1>
    <button id="stringifyBtn">JSON.stringify</button>
    <button id="parseBtn">JSON.parse</button>
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        let results = [];
        
        // JSON.stringify
        document.getElementById('stringifyBtn').addEventListener('click', function() {
            results = [];
            
            const obj = {
                name: '太郎',
                age: 25,
                city: '東京',
                hobbies: ['読書', '映画']
            };
            
            results.push('<h2>JSON.stringify（オブジェクト→JSON文字列）</h2>');
            results.push(`<p>元のオブジェクト: ${JSON.stringify(obj, null, 2)}</p>`);
            
            const json = JSON.stringify(obj);
            results.push(`<p>JSON文字列: ${json}</p>`);
            
            output.innerHTML = results.join('');
        });
        
        // JSON.parse
        document.getElementById('parseBtn').addEventListener('click', function() {
            results = [];
            
            const json = '{"name":"花子","age":30,"city":"大阪","hobbies":["旅行","料理"]}';
            
            results.push('<h2>JSON.parse（JSON文字列→オブジェクト）</h2>');
            results.push(`<p>JSON文字列: ${json}</p>`);
            
            const obj = JSON.parse(json);
            results.push(`<p>オブジェクト:</p>`);
            results.push(`<p>名前: ${obj.name}</p>`);
            results.push(`<p>年齢: ${obj.age}歳</p>`);
            results.push(`<p>居住地: ${obj.city}</p>`);
            results.push(`<p>趣味: ${obj.hobbies.join(', ')}</p>`);
            
            output.innerHTML = results.join('');
        });
        
        // JSONの特徴
        results.push('<h2>JSONの特徴</h2>');
        results.push('<p>• テキスト形式: 人間が読める形式</p>');
        results.push('<p>• 軽量: XMLなどより軽量</p>');
        results.push('<p>• 汎用性: 様々な言語で使える</p>');
        results.push('<p>• データ交換: サーバーとクライアント間でデータをやり取り</p>');
        
        // 実践例: データの保存と読み込み
        results.push('<h2>実践例: データの保存と読み込み</h2>');
        
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'データを保存';
        saveBtn.style.marginRight = '10px';
        
        const loadBtn = document.createElement('button');
        loadBtn.textContent = 'データを読み込み';
        
        document.body.appendChild(saveBtn);
        document.body.appendChild(loadBtn);
        
        saveBtn.addEventListener('click', function() {
            const data = {
                name: '太郎',
                age: 25,
                timestamp: new Date().toISOString()
            };
            
            // localStorageに保存（JSON文字列として）
            localStorage.setItem('userData', JSON.stringify(data));
            output.innerHTML = '<p>データを保存しました</p>';
        });
        
        loadBtn.addEventListener('click', function() {
            const json = localStorage.getItem('userData');
            if (json) {
                const data = JSON.parse(json);
                output.innerHTML = `
                    <p>読み込んだデータ:</p>
                    <p>名前: ${data.name}</p>
                    <p>年齢: ${data.age}歳</p>
                    <p>保存日時: ${data.timestamp}</p>
                `;
            } else {
                output.innerHTML = '<p>保存されたデータがありません</p>';
            }
        });
        
        output.innerHTML = results.join('');
        
        // コンソールで確認
        console.log('=== JSON ===');
        console.log('JSON.stringify: オブジェクト→JSON文字列');
        console.log('JSON.parse: JSON文字列→オブジェクト');
    </script>
</body>
</html>
```

---

## エラーハンドリング - try...catch文

### エラーハンドリングとは
エラーハンドリングは、**エラーが発生したときに適切に処理する**ことです。

### try-catch文の基本構文

```javascript
try {
    // エラーが発生する可能性のあるコード
} catch (error) {
    // エラーが発生した場合の処理
} finally {
    // 必ず実行される処理（オプション）
}
```

### try-catch文の使い方

```javascript
try {
    const result = riskyOperation();
    console.log(result);
} catch (error) {
    console.error('エラーが発生しました:', error.message);
} finally {
    console.log('処理が完了しました');
}
```

### エラーの種類

#### 構文エラー（SyntaxError）
```javascript
// 構文が間違っている
// const x = ; // SyntaxError
```

#### 参照エラー（ReferenceError）
```javascript
try {
    console.log(undefinedVariable);
} catch (error) {
    console.error('参照エラー:', error.name);
}
```

#### 型エラー（TypeError）
```javascript
try {
    const num = 42;
    num.toUpperCase(); // TypeError
} catch (error) {
    console.error('型エラー:', error.name);
}
```

### 実践例: エラーハンドリング

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>エラーハンドリング - try...catch文</title>
</head>
<body>
    <h1>エラーハンドリング - try...catch文</h1>
    <button id="errorBtn">エラーを発生させる</button>
    <button id="safeBtn">安全な処理</button>
    <button id="finallyBtn">finallyの例</button>
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        
        // エラーを発生させる
        document.getElementById('errorBtn').addEventListener('click', function() {
            output.innerHTML = '';
            
            try {
                // 意図的にエラーを発生
                const result = undefinedVariable.someMethod();
                output.innerHTML = `<p>結果: ${result}</p>`;
            } catch (error) {
                output.innerHTML = `
                    <h2>エラーが発生しました</h2>
                    <p>エラー名: ${error.name}</p>
                    <p>エラーメッセージ: ${error.message}</p>
                    <p>スタック: ${error.stack}</p>
                `;
            }
        });
        
        // 安全な処理
        document.getElementById('safeBtn').addEventListener('click', function() {
            output.innerHTML = '';
            
            try {
                const data = { name: '太郎', age: 25 };
                const json = JSON.stringify(data);
                const parsed = JSON.parse(json);
                
                output.innerHTML = `
                    <h2>正常に処理されました</h2>
                    <p>名前: ${parsed.name}</p>
                    <p>年齢: ${parsed.age}歳</p>
                `;
            } catch (error) {
                output.innerHTML = `<p>エラー: ${error.message}</p>`;
            }
        });
        
        // finallyの例
        document.getElementById('finallyBtn').addEventListener('click', function() {
            output.innerHTML = '';
            
            try {
                output.innerHTML += '<p>tryブロックを実行中...</p>';
                
                // ランダムにエラーを発生
                if (Math.random() > 0.5) {
                    throw new Error('ランダムエラー');
                }
                
                output.innerHTML += '<p>正常に完了しました</p>';
            } catch (error) {
                output.innerHTML += `<p>エラー: ${error.message}</p>`;
            } finally {
                output.innerHTML += '<p>finallyブロックが実行されました（必ず実行）</p>';
            }
        });
        
        // 実践例: データ取得のエラーハンドリング
        async function fetchDataSafely() {
            try {
                const response = await fetch('https://jsonplaceholder.typicode.com/posts/1');
                
                if (!response.ok) {
                    throw new Error(`HTTPエラー: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('データ取得エラー:', error);
                return null;
            }
        }
        
        const fetchBtn = document.createElement('button');
        fetchBtn.textContent = 'データを安全に取得';
        fetchBtn.style.marginTop = '10px';
        document.body.appendChild(fetchBtn);
        
        fetchBtn.addEventListener('click', async function() {
            output.innerHTML = '<p>データを取得中...</p>';
            
            const data = await fetchDataSafely();
            if (data) {
                output.innerHTML = `
                    <h2>データを取得しました</h2>
                    <p>タイトル: ${data.title}</p>
                `;
            } else {
                output.innerHTML = '<p>データの取得に失敗しました</p>';
            }
        });
        
        // 実践例: JSON解析のエラーハンドリング
        function parseJSONSafely(jsonString) {
            try {
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('JSON解析エラー:', error);
                return null;
            }
        }
        
        const jsonBtn = document.createElement('button');
        jsonBtn.textContent = 'JSONを安全に解析';
        jsonBtn.style.marginTop = '10px';
        document.body.appendChild(jsonBtn);
        
        jsonBtn.addEventListener('click', function() {
            const validJson = '{"name":"太郎","age":25}';
            const invalidJson = '{name:"太郎"}'; // 無効なJSON
            
            const result1 = parseJSONSafely(validJson);
            const result2 = parseJSONSafely(invalidJson);
            
            output.innerHTML = `
                <h2>JSON解析の結果</h2>
                <p>有効なJSON: ${result1 ? '成功' : '失敗'}</p>
                <p>無効なJSON: ${result2 ? '成功' : '失敗'}</p>
            `;
        });
        
        // コンソールで確認
        console.log('=== エラーハンドリング ===');
        console.log('try-catch文でエラーを適切に処理できます');
        console.log('finallyブロックは必ず実行されます');
    </script>
</body>
</html>
```

---

## 便利な組み込みオブジェクト (Math, Date, Map, Set)

JavaScriptには、便利な組み込みオブジェクトが用意されています。

### Mathオブジェクト

数学的な計算を行うためのオブジェクトです。

#### 主なMathメソッド

```javascript
Math.abs(-10);        // 10（絶対値）
Math.round(3.7);     // 4（四捨五入）
Math.floor(3.7);     // 3（切り捨て）
Math.ceil(3.2);       // 4（切り上げ）
Math.max(1, 5, 3);    // 5（最大値）
Math.min(1, 5, 3);    // 1（最小値）
Math.random();        // 0以上1未満の乱数
Math.PI;              // 3.14159...（円周率）
```

### Dateオブジェクト

日付と時刻を扱うためのオブジェクトです。

#### 主なDateメソッド

```javascript
const now = new Date();
now.getFullYear();    // 年
now.getMonth();       // 月（0-11）
now.getDate();        // 日
now.getHours();       // 時
now.getMinutes();     // 分
now.getSeconds();     // 秒
```

### Mapオブジェクト

キーと値のペアを保存するオブジェクトです。通常のオブジェクトと違い、任意の型をキーにできます。

```javascript
const map = new Map();
map.set('name', '太郎');
map.set(1, '数値キー');
map.get('name');      // '太郎'
map.has('name');      // true
map.delete('name');   // 削除
```

### Setオブジェクト

重複しない値の集合を保存するオブジェクトです。

```javascript
const set = new Set();
set.add(1);
set.add(2);
set.add(1);          // 重複は無視される
set.size;            // 2
set.has(1);          // true
set.delete(1);       // 削除
```

### 実践例: 便利な組み込みオブジェクト

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>便利な組み込みオブジェクト</title>
</head>
<body>
    <h1>便利な組み込みオブジェクト (Math, Date, Map, Set)</h1>
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        let results = [];
        
        // Mathオブジェクト
        results.push('<h2>Mathオブジェクト</h2>');
        results.push(`<p>Math.abs(-10): ${Math.abs(-10)}（絶対値）</p>`);
        results.push(`<p>Math.round(3.7): ${Math.round(3.7)}（四捨五入）</p>`);
        results.push(`<p>Math.floor(3.7): ${Math.floor(3.7)}（切り捨て）</p>`);
        results.push(`<p>Math.ceil(3.2): ${Math.ceil(3.2)}（切り上げ）</p>`);
        results.push(`<p>Math.max(1, 5, 3): ${Math.max(1, 5, 3)}（最大値）</p>`);
        results.push(`<p>Math.min(1, 5, 3): ${Math.min(1, 5, 3)}（最小値）</p>`);
        results.push(`<p>Math.random(): ${Math.random().toFixed(4)}（乱数）</p>`);
        results.push(`<p>Math.PI: ${Math.PI}（円周率）</p>`);
        
        // Dateオブジェクト
        results.push('<h2>Dateオブジェクト</h2>');
        
        const now = new Date();
        results.push(`<p>現在の日時: ${now}</p>`);
        results.push(`<p>年: ${now.getFullYear()}</p>`);
        results.push(`<p>月: ${now.getMonth() + 1}（0-11なので+1）</p>`);
        results.push(`<p>日: ${now.getDate()}</p>`);
        results.push(`<p>時: ${now.getHours()}</p>`);
        results.push(`<p>分: ${now.getMinutes()}</p>`);
        results.push(`<p>秒: ${now.getSeconds()}</p>`);
        
        // 日付のフォーマット
        const formatted = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
        results.push(`<p>フォーマット済み: ${formatted}</p>`);
        
        // Mapオブジェクト
        results.push('<h2>Mapオブジェクト</h2>');
        
        const map = new Map();
        map.set('name', '太郎');
        map.set('age', 25);
        map.set(1, '数値キー');
        map.set(true, '真偽値キー');
        
        results.push(`<p>map.get('name'): ${map.get('name')}</p>`);
        results.push(`<p>map.get(1): ${map.get(1)}</p>`);
        results.push(`<p>map.has('age'): ${map.has('age')}</p>`);
        results.push(`<p>map.size: ${map.size}</p>`);
        
        // Mapの反復
        results.push('<p>Mapの内容:</p>');
        results.push('<ul>');
        for (const [key, value] of map) {
            results.push(`<li>${key}: ${value}</li>`);
        }
        results.push('</ul>');
        
        // Setオブジェクト
        results.push('<h2>Setオブジェクト</h2>');
        
        const set = new Set();
        set.add(1);
        set.add(2);
        set.add(3);
        set.add(1);  // 重複は無視される
        
        results.push(`<p>set.size: ${set.size}（重複は無視）</p>`);
        results.push(`<p>set.has(1): ${set.has(1)}</p>`);
        
        // Setの反復
        results.push('<p>Setの内容:</p>');
        results.push('<ul>');
        for (const value of set) {
            results.push(`<li>${value}</li>`);
        }
        results.push('</ul>');
        
        // 実践例: 重複の除去
        results.push('<h2>実践例: 重複の除去</h2>');
        
        const numbers = [1, 2, 2, 3, 3, 3, 4, 5];
        const uniqueNumbers = [...new Set(numbers)];
        
        results.push(`<p>元の配列: [${numbers.join(', ')}]</p>`);
        results.push(`<p>重複除去後: [${uniqueNumbers.join(', ')}]</p>`);
        
        // 実践例: 日付の計算
        results.push('<h2>実践例: 日付の計算</h2>');
        
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        results.push(`<p>今日: ${today.toLocaleDateString('ja-JP')}</p>`);
        results.push(`<p>明日: ${tomorrow.toLocaleDateString('ja-JP')}</p>`);
        
        // 実践例: ランダムな数値の生成
        results.push('<h2>実践例: ランダムな数値の生成</h2>');
        
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        results.push(`<p>1から10の乱数: ${getRandomInt(1, 10)}</p>`);
        results.push(`<p>1から10の乱数: ${getRandomInt(1, 10)}</p>`);
        results.push(`<p>1から10の乱数: ${getRandomInt(1, 10)}</p>`);
        
        output.innerHTML = results.join('');
        
        // コンソールで確認
        console.log('=== 便利な組み込みオブジェクト ===');
        console.log('Math: 数学的な計算');
        console.log('Date: 日付と時刻');
        console.log('Map: キーと値のペア');
        console.log('Set: 重複しない値の集合');
    </script>
</body>
</html>
```

---

## まとめ

この章では、応用・便利な機能について学びました。

### 学んだこと
- JSON（データをやり取りする共通言語）
- エラーハンドリング（try-catch文）
- 便利な組み込みオブジェクト（Math, Date, Map, Set）

### 重要なポイント
1. **JSON**: データ交換の標準形式、`JSON.stringify`と`JSON.parse`で変換
2. **try-catch**: エラーを適切に処理、`finally`で必ず実行される処理を書ける
3. **Math**: 数学的な計算、乱数生成など
4. **Date**: 日付と時刻の操作
5. **Map/Set**: 高度なデータ構造

### 次のステップ
これでJavaScriptの基礎を一通り学びました。実践的なプロジェクトに取り組んで、知識を定着させましょう！

---

## 演習問題

### 問題1: JSONの変換
オブジェクト`{name: '太郎', age: 25}`をJSON文字列に変換してください。

<details>
<summary>解答例</summary>

```javascript
const obj = { name: '太郎', age: 25 };
const json = JSON.stringify(obj);
console.log(json); // '{"name":"太郎","age":25}'
```
</details>

### 問題2: JSONの解析
JSON文字列`'{"name":"花子","age":30}'`をオブジェクトに変換してください。

<details>
<summary>解答例</summary>

```javascript
const json = '{"name":"花子","age":30}';
const obj = JSON.parse(json);
console.log(obj.name); // '花子'
```
</details>

### 問題3: エラーハンドリング
`JSON.parse`でエラーが発生する可能性があるコードを、try-catch文で保護してください。

<details>
<summary>解答例</summary>

```javascript
try {
    const json = '{invalid json}';
    const obj = JSON.parse(json);
    console.log(obj);
} catch (error) {
    console.error('JSON解析エラー:', error.message);
}
```
</details>

### 問題4: Mathオブジェクト
1から100までの乱数を生成してください。

<details>
<summary>解答例</summary>

```javascript
const random = Math.floor(Math.random() * 100) + 1;
console.log(random); // 1から100の間の乱数
```
</details>

### 問題5: Setオブジェクト
配列`[1, 2, 2, 3, 3, 3, 4]`から重複を除去してください。

<details>
<summary>解答例</summary>

```javascript
const numbers = [1, 2, 2, 3, 3, 3, 4];
const unique = [...new Set(numbers)];
console.log(unique); // [1, 2, 3, 4]
```
</details>

---

お疲れ様でした！JavaScriptの基礎を一通り学びました。実践的なプロジェクトに取り組んで、知識を定着させましょう！


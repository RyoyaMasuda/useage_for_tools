# 10-3. 型安全な開発

この章では、TypeScriptを使った型安全なReact開発について学びます。型定義ファイル（.d.ts）の扱い方と、共通の型定義を管理する方法を学びます。型安全な開発を理解することで、より保守しやすく、バグの少ないReactアプリケーションを作成できるようになります。

---

## 目次

- [型定義ファイル (d.ts) の扱い](#型定義ファイル-dts-の扱い)
- [共通の型定義管理](#共通の型定義管理)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## 型定義ファイル (d.ts) の扱い

### 型定義ファイルとは
型定義ファイル（.d.ts）は、**JavaScriptライブラリやモジュールの型情報を定義するファイル**です。TypeScriptが型チェックを行うために使用されます。

### 日常生活での例
- **説明書**: 製品の使い方を説明する説明書（型定義ファイル）
- **契約書**: 契約の内容を定義する契約書（型定義ファイル）
- **仕様書**: システムの仕様を定義する仕様書（型定義ファイル）

### 型定義ファイルの種類

#### 1. ライブラリの型定義ファイル

サードパーティのJavaScriptライブラリに型定義を提供するファイルです。

```typescript
// @types/react/index.d.ts（例）
declare module 'react' {
    export function useState<T>(initialState: T): [T, (value: T) => void];
    // ...
}
```

#### 2. プロジェクト内の型定義ファイル

プロジェクト内で使用する型を定義するファイルです。

```typescript
// types/user.d.ts
export interface User {
    id: number;
    name: string;
    email: string;
}
```

#### 3. グローバル型定義ファイル

グローバルスコープで使用できる型を定義するファイルです。

```typescript
// types/global.d.ts
declare global {
    interface Window {
        myCustomProperty: string;
    }
}
```

### 型定義ファイルの作成

#### 基本的な型定義ファイル

```typescript
// types/api.d.ts
export interface ApiResponse<T> {
    data: T;
    status: number;
    message: string;
}

export interface User {
    id: number;
    name: string;
    email: string;
}

export interface Post {
    id: number;
    title: string;
    body: string;
    userId: number;
}
```

#### モジュール拡張の型定義

```typescript
// types/module.d.ts
declare module 'some-library' {
    export interface SomeType {
        value: string;
    }
    
    export function someFunction(param: SomeType): void;
}
```

### 実践例: 型定義ファイルの作成と使用

```typescript
// types/user.d.ts
export interface User {
    id: number;
    name: string;
    email: string;
    age?: number;
    createdAt: Date;
}

export interface UserCreateInput {
    name: string;
    email: string;
    age?: number;
}

export interface UserUpdateInput {
    name?: string;
    email?: string;
    age?: number;
}

// types/api.d.ts
export interface ApiResponse<T> {
    data: T;
    status: number;
    message: string;
}

export interface ApiError {
    message: string;
    code: string;
    details?: Record<string, unknown>;
}

// types/post.d.ts
export interface Post {
    id: number;
    title: string;
    body: string;
    userId: number;
    createdAt: Date;
    updatedAt: Date;
}

export interface PostCreateInput {
    title: string;
    body: string;
    userId: number;
}

// src/components/UserList.tsx
import React from 'react';
import { User } from '../types/user';

interface UserListProps {
    users: User[];
    onUserClick: (user: User) => void;
}

export const UserList: React.FC<UserListProps> = ({ users, onUserClick }) => {
    return (
        <ul>
            {users.map(user => (
                <li key={user.id} onClick={() => onUserClick(user)}>
                    {user.name} ({user.email})
                </li>
            ))}
        </ul>
    );
};

// src/hooks/useUsers.ts
import { useState, useEffect } from 'react';
import { User } from '../types/user';
import { ApiResponse } from '../types/api';

export function useUsers() {
    const [users, setUsers] = useState<User[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<Error | null>(null);
    
    useEffect(() => {
        fetch('https://api.example.com/users')
            .then(response => response.json())
            .then((data: ApiResponse<User[]>) => {
                setUsers(data.data);
                setLoading(false);
            })
            .catch((err: Error) => {
                setError(err);
                setLoading(false);
            });
    }, []);
    
    return { users, loading, error };
}
```

### グローバル型定義ファイル

#### グローバル型の定義

```typescript
// types/global.d.ts
declare global {
    interface Window {
        myCustomProperty: string;
        myCustomMethod: () => void;
    }
    
    namespace MyApp {
        interface Config {
            apiUrl: string;
            version: string;
        }
    }
}

export {};
```

#### グローバル型の使用

```typescript
// src/utils/config.ts
export function getConfig(): MyApp.Config {
    return {
        apiUrl: window.myCustomProperty,
        version: '1.0.0'
    };
}

// src/components/App.tsx
import React, { useEffect } from 'react';

export const App: React.FC = () => {
    useEffect(() => {
        // グローバル型が使用できる
        window.myCustomMethod();
    }, []);
    
    return <div>App</div>;
};
```

### 環境変数の型定義

```typescript
// types/env.d.ts
declare namespace NodeJS {
    interface ProcessEnv {
        REACT_APP_API_URL: string;
        REACT_APP_API_KEY: string;
        REACT_APP_ENV: 'development' | 'production' | 'test';
    }
}

// src/config/api.ts
export const API_URL = process.env.REACT_APP_API_URL;
export const API_KEY = process.env.REACT_APP_API_KEY;
export const ENV = process.env.REACT_APP_ENV;
```

### 実践例: 環境変数の型定義

```typescript
// types/env.d.ts
declare namespace NodeJS {
    interface ProcessEnv {
        REACT_APP_API_URL: string;
        REACT_APP_API_KEY: string;
        REACT_APP_ENV: 'development' | 'production' | 'test';
        REACT_APP_DEBUG?: string;
    }
}

// src/config/env.ts
export const config = {
    apiUrl: process.env.REACT_APP_API_URL,
    apiKey: process.env.REACT_APP_API_KEY,
    env: process.env.REACT_APP_ENV,
    debug: process.env.REACT_APP_DEBUG === 'true'
};

// 型安全に環境変数にアクセスできる
if (config.env === 'development') {
    console.log('開発モード');
}
```

---

## 共通の型定義管理

### 共通の型定義とは
共通の型定義は、**プロジェクト全体で使用する型を1箇所で管理する**仕組みです。

### 型定義の管理方法

#### 1. 単一ファイルでの管理

すべての型を1つのファイルで管理する方法です。

```typescript
// types/index.ts
export interface User {
    id: number;
    name: string;
    email: string;
}

export interface Post {
    id: number;
    title: string;
    body: string;
}

export type Status = 'pending' | 'approved' | 'rejected';
```

#### 2. ドメインごとに分割

ドメイン（機能）ごとに型定義ファイルを分割する方法です。

```typescript
// types/user.ts
export interface User {
    id: number;
    name: string;
    email: string;
}

// types/post.ts
export interface Post {
    id: number;
    title: string;
    body: string;
}

// types/index.ts
export * from './user';
export * from './post';
```

#### 3. カテゴリごとに分割

カテゴリ（API、UI、Utilsなど）ごとに型定義ファイルを分割する方法です。

```typescript
// types/api.ts
export interface ApiResponse<T> {
    data: T;
    status: number;
}

// types/ui.ts
export interface ButtonProps {
    label: string;
    onClick: () => void;
}

// types/utils.ts
export type Nullable<T> = T | null;
export type Optional<T> = T | undefined;
```

### 実践例: 共通の型定義管理

```typescript
// types/domain/user.ts
export interface User {
    id: number;
    name: string;
    email: string;
    age?: number;
    createdAt: Date;
}

export interface UserCreateInput {
    name: string;
    email: string;
    age?: number;
}

export interface UserUpdateInput {
    name?: string;
    email?: string;
    age?: number;
}

export type UserRole = 'admin' | 'user' | 'guest';

// types/domain/post.ts
export interface Post {
    id: number;
    title: string;
    body: string;
    userId: number;
    createdAt: Date;
    updatedAt: Date;
}

export interface PostCreateInput {
    title: string;
    body: string;
    userId: number;
}

export interface PostUpdateInput {
    title?: string;
    body?: string;
}

// types/api/common.ts
export interface ApiResponse<T> {
    data: T;
    status: number;
    message: string;
}

export interface ApiError {
    message: string;
    code: string;
    details?: Record<string, unknown>;
}

export interface PaginationParams {
    page: number;
    limit: number;
}

export interface PaginatedResponse<T> {
    data: T[];
    total: number;
    page: number;
    limit: number;
}

// types/ui/common.ts
export interface ButtonProps {
    label: string;
    onClick: () => void;
    variant?: 'primary' | 'secondary' | 'danger';
    disabled?: boolean;
}

export interface InputProps {
    value: string;
    onChange: (value: string) => void;
    placeholder?: string;
    type?: 'text' | 'email' | 'password';
}

export interface ModalProps {
    isOpen: boolean;
    onClose: () => void;
    title: string;
    children: React.ReactNode;
}

// types/utils.ts
export type Nullable<T> = T | null;
export type Optional<T> = T | undefined;
export type Maybe<T> = T | null | undefined;

export type ID = number | string;

export type DeepPartial<T> = {
    [P in keyof T]?: T[P] extends object ? DeepPartial<T[P]> : T[P];
};

// types/index.ts
// ドメイン型
export * from './domain/user';
export * from './domain/post';

// API型
export * from './api/common';

// UI型
export * from './ui/common';

// ユーティリティ型
export * from './utils';

// src/components/UserForm.tsx
import React, { useState } from 'react';
import { UserCreateInput } from '../types';

interface UserFormProps {
    onSubmit: (data: UserCreateInput) => void;
}

export const UserForm: React.FC<UserFormProps> = ({ onSubmit }) => {
    const [formData, setFormData] = useState<UserCreateInput>({
        name: '',
        email: '',
        age: undefined
    });
    
    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        onSubmit(formData);
    };
    
    return (
        <form onSubmit={handleSubmit}>
            <input
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="名前"
            />
            <input
                type="email"
                value={formData.email}
                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                placeholder="メールアドレス"
            />
            <input
                type="number"
                value={formData.age ?? ''}
                onChange={(e) => setFormData({ 
                    ...formData, 
                    age: e.target.value ? Number(e.target.value) : undefined 
                })}
                placeholder="年齢"
            />
            <button type="submit">送信</button>
        </form>
    );
};

// src/hooks/useApi.ts
import { useState } from 'react';
import { ApiResponse, ApiError } from '../types';

export function useApi<T>() {
    const [data, setData] = useState<T | null>(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<ApiError | null>(null);
    
    const fetchData = async (url: string) => {
        setLoading(true);
        setError(null);
        
        try {
            const response = await fetch(url);
            const result: ApiResponse<T> = await response.json();
            setData(result.data);
        } catch (err) {
            setError({
                message: 'データの取得に失敗しました',
                code: 'FETCH_ERROR'
            });
        } finally {
            setLoading(false);
        }
    };
    
    return { data, loading, error, fetchData };
}
```

### 型定義のベストプラクティス

#### 1. 一貫性のある命名規則

```typescript
// ✅ 良い例: 一貫性のある命名
interface User {}
interface UserCreateInput {}
interface UserUpdateInput {}
type UserRole = 'admin' | 'user';

// ❌ 悪い例: 一貫性のない命名
interface User {}
interface CreateUser {}
interface UpdateUserData {}
type UserRoles = 'admin' | 'user';
```

#### 2. 型の再利用

```typescript
// ✅ 良い例: 型の再利用
type ID = number | string;
interface BaseEntity {
    id: ID;
    createdAt: Date;
}
interface User extends BaseEntity {
    name: string;
}
interface Post extends BaseEntity {
    title: string;
}

// ❌ 悪い例: 型の重複
interface User {
    id: number | string;
    createdAt: Date;
    name: string;
}
interface Post {
    id: number | string;
    createdAt: Date;
    title: string;
}
```

#### 3. 型の分割

```typescript
// ✅ 良い例: 適切な分割
// types/user.ts
export interface User {}
export interface UserCreateInput {}

// types/post.ts
export interface Post {}
export interface PostCreateInput {}

// ❌ 悪い例: すべてを1つのファイルに
// types/all.ts
export interface User {}
export interface Post {}
export interface Comment {}
// ... 100以上の型定義
```

#### 4. 型のエクスポート

```typescript
// ✅ 良い例: 明確なエクスポート
// types/index.ts
export * from './user';
export * from './post';

// ❌ 悪い例: 型の再エクスポートが不明確
// types/index.ts
import { User } from './user';
import { Post } from './post';
export { User, Post };
```

### 実践例: 大規模プロジェクトでの型定義管理

```typescript
// types/domain/user/index.ts
export interface User {
    id: number;
    name: string;
    email: string;
}

export interface UserCreateInput {
    name: string;
    email: string;
}

// types/domain/post/index.ts
export interface Post {
    id: number;
    title: string;
    body: string;
    userId: number;
}

export interface PostCreateInput {
    title: string;
    body: string;
    userId: number;
}

// types/api/index.ts
export interface ApiResponse<T> {
    data: T;
    status: number;
}

export interface ApiError {
    message: string;
    code: string;
}

// types/ui/index.ts
export interface ButtonProps {
    label: string;
    onClick: () => void;
}

export interface InputProps {
    value: string;
    onChange: (value: string) => void;
}

// types/index.ts
// すべての型を再エクスポート
export * from './domain/user';
export * from './domain/post';
export * from './api';
export * from './ui';

// src/components/UserList.tsx
import React from 'react';
import { User } from '../../types';

interface UserListProps {
    users: User[];
}

export const UserList: React.FC<UserListProps> = ({ users }) => {
    return (
        <ul>
            {users.map(user => (
                <li key={user.id}>{user.name}</li>
            ))}
        </ul>
    );
};
```

---

## まとめ

この章では、TypeScriptを使った型安全なReact開発について学びました。

### 学んだこと
- **型定義ファイル**: JavaScriptライブラリやモジュールの型情報を定義
- **型定義ファイルの種類**: ライブラリの型定義、プロジェクト内の型定義、グローバル型定義
- **共通の型定義管理**: 単一ファイル、ドメインごと、カテゴリごとの管理方法
- **型定義のベストプラクティス**: 一貫性のある命名、型の再利用、適切な分割

### 重要なポイント
1. **型定義ファイル**: .d.tsファイルで型情報を定義
2. **グローバル型**: declare globalでグローバル型を定義
3. **環境変数**: ProcessEnvインターフェースで環境変数の型を定義
4. **型の管理**: プロジェクトの規模に応じて適切な管理方法を選択
5. **ベストプラクティス**: 一貫性、再利用性、適切な分割を心がける

### 使い分けの目安
- **単一ファイル**: 小規模なプロジェクト
- **ドメインごと**: 中規模以上のプロジェクト
- **カテゴリごと**: 大規模なプロジェクト

### 次のステップ
型安全な開発を理解することで、より保守しやすく、バグの少ないReactアプリケーションを作成できるようになります。実際のプロジェクトで積極的に型定義を活用して、コードの品質を向上させましょう。

---

## 演習問題

### 問題1: 基本的な型定義ファイルの作成
ユーザーの型定義ファイル（types/user.d.ts）を作成してください。

<details>
<summary>解答例</summary>

```typescript
// types/user.d.ts
export interface User {
    id: number;
    name: string;
    email: string;
    age?: number;
}

export interface UserCreateInput {
    name: string;
    email: string;
    age?: number;
}
```
</details>

### 問題2: グローバル型の定義
Windowオブジェクトにカスタムプロパティを追加する型定義ファイルを作成してください。

<details>
<summary>解答例</summary>

```typescript
// types/global.d.ts
declare global {
    interface Window {
        myCustomProperty: string;
        myCustomMethod: () => void;
    }
}

export {};
```
</details>

### 問題3: 環境変数の型定義
環境変数の型定義ファイルを作成してください。

<details>
<summary>解答例</summary>

```typescript
// types/env.d.ts
declare namespace NodeJS {
    interface ProcessEnv {
        REACT_APP_API_URL: string;
        REACT_APP_API_KEY: string;
        REACT_APP_ENV: 'development' | 'production';
    }
}
```
</details>

### 問題4: 共通の型定義管理
ドメインごとに型定義を分割し、index.tsで再エクスポートしてください。

<details>
<summary>解答例</summary>

```typescript
// types/user.ts
export interface User {
    id: number;
    name: string;
    email: string;
}

// types/post.ts
export interface Post {
    id: number;
    title: string;
    body: string;
}

// types/index.ts
export * from './user';
export * from './post';
```
</details>

### 問題5: 型定義を使用したコンポーネント
型定義ファイルで定義した型を使用して、UserListコンポーネントを作成してください。

<details>
<summary>解答例</summary>

```typescript
// types/user.d.ts
export interface User {
    id: number;
    name: string;
    email: string;
}

// src/components/UserList.tsx
import React from 'react';
import { User } from '../types/user';

interface UserListProps {
    users: User[];
}

export const UserList: React.FC<UserListProps> = ({ users }) => {
    return (
        <ul>
            {users.map(user => (
                <li key={user.id}>
                    {user.name} ({user.email})
                </li>
            ))}
        </ul>
    );
};
```
</details>

---

お疲れ様でした！次の章に進みましょう。


# 4-2. スキーマバリデーション

この章では、スキーマバリデーションライブラリ（Zod または Yup）を使ったバリデーション定義について学びます。スキーマバリデーションを使うことで、型安全で保守しやすいバリデーションロジックを実装できるようになります。

---

## 目次

- [スキーマバリデーションとは](#スキーマバリデーションとは)
- [Zod を用いたバリデーション定義](#zod-を用いたバリデーション定義)
- [Yup を用いたバリデーション定義](#yup-を用いたバリデーション定義)
- [React Hook Formとの連携](#react-hook-formとの連携)
- [まとめ](#まとめ)
- [演習問題](#演習問題)

---

## スキーマバリデーションとは

### スキーマバリデーションとは
スキーマバリデーションは、**データの構造とルールを定義（スキーマ）し、そのスキーマに基づいてデータを検証する**手法です。

### 日常生活での例
- **申請書**: 申請書のフォーマット（スキーマ）に従って記入されているか確認
- **契約書**: 契約書の必須項目（スキーマ）がすべて記入されているか確認
- **検査表**: 検査項目（スキーマ）に基づいて、すべての項目が合格しているか確認

### スキーマバリデーションのメリット
1. **型安全性**: TypeScriptと組み合わせて型安全なバリデーションができる
2. **再利用性**: 同じスキーマを複数の場所で使える
3. **保守性**: バリデーションルールを1箇所で管理できる
4. **一貫性**: 同じルールを確実に適用できる

### 主要なライブラリ

#### Zod
- **特徴**: TypeScriptファースト、型推論が強力
- **用途**: TypeScriptプロジェクトでの型安全なバリデーション

#### Yup
- **特徴**: 柔軟で強力なバリデーション機能
- **用途**: JavaScript/TypeScript両方で使用可能

---

## Zod を用いたバリデーション定義

### Zodとは
Zodは、**TypeScriptファーストのスキーマバリデーションライブラリ**です。スキーマから自動的にTypeScriptの型を推論できるのが特徴です。

### Zodのインストール

```bash
npm install zod
```

### 基本的なスキーマ定義

```jsx
import { z } from 'zod';

// 文字列のスキーマ
const stringSchema = z.string();

// 数値のスキーマ
const numberSchema = z.number();

// 真偽値のスキーマ
const booleanSchema = z.boolean();
```

### オブジェクトスキーマの定義

```jsx
import { z } from 'zod';

// ユーザースキーマの定義
const userSchema = z.object({
    name: z.string(),
    age: z.number(),
    email: z.string().email()
});

// 型の推論（自動的に型が生成される）
type User = z.infer<typeof userSchema>;
// type User = { name: string; age: number; email: string; }
```

### バリデーションの実行

```jsx
import { z } from 'zod';

const userSchema = z.object({
    name: z.string().min(1, "名前は必須です"),
    age: z.number().min(0, "年齢は0以上である必要があります"),
    email: z.string().email("有効なメールアドレスを入力してください")
});

// バリデーションの実行
const result = userSchema.safeParse({
    name: "太郎",
    age: 25,
    email: "taro@example.com"
});

if (result.success) {
    console.log(result.data); // バリデーション成功
} else {
    console.log(result.error.errors); // エラー情報
}
```

### 実践例: Zodによるバリデーション

```jsx
// src/schemas/userSchema.js
import { z } from 'zod';

// 基本的なユーザースキーマ
export const userSchema = z.object({
    name: z.string()
        .min(1, "名前は必須です")
        .max(50, "名前は50文字以内で入力してください"),
    age: z.number()
        .min(0, "年齢は0以上である必要があります")
        .max(150, "年齢は150以下である必要があります"),
    email: z.string()
        .email("有効なメールアドレスを入力してください"),
    password: z.string()
        .min(8, "パスワードは8文字以上である必要があります")
        .regex(/[A-Z]/, "パスワードには大文字を含める必要があります")
        .regex(/[a-z]/, "パスワードには小文字を含める必要があります")
        .regex(/[0-9]/, "パスワードには数字を含める必要があります")
});

// 型の推論
export type User = z.infer<typeof userSchema>;

// フォームスキーマ（一部のフィールドをオプショナルに）
export const userFormSchema = userSchema.partial({
    age: true
});

// src/components/UserForm.jsx
import React, { useState } from 'react';
import { userSchema, type User } from '../schemas/userSchema';

function UserForm() {
    const [formData, setFormData] = useState({
        name: '',
        age: '',
        email: '',
        password: ''
    });
    const [errors, setErrors] = useState({});
    const [isValid, setIsValid] = useState(false);
    
    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: name === 'age' ? (value === '' ? '' : Number(value)) : value
        }));
    };
    
    const handleSubmit = (e) => {
        e.preventDefault();
        
        // バリデーションの実行
        const result = userSchema.safeParse(formData);
        
        if (result.success) {
            setIsValid(true);
            setErrors({});
            console.log('バリデーション成功:', result.data);
            // フォーム送信処理
        } else {
            setIsValid(false);
            // エラーをオブジェクト形式に変換
            const errorMap = {};
            result.error.errors.forEach((error) => {
                errorMap[error.path[0]] = error.message;
            });
            setErrors(errorMap);
        }
    };
    
    return (
        <form onSubmit={handleSubmit}>
            <div>
                <label>名前</label>
                <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleChange}
                />
                {errors.name && <span style={{ color: 'red' }}>{errors.name}</span>}
            </div>
            
            <div>
                <label>年齢</label>
                <input
                    type="number"
                    name="age"
                    value={formData.age}
                    onChange={handleChange}
                />
                {errors.age && <span style={{ color: 'red' }}>{errors.age}</span>}
            </div>
            
            <div>
                <label>メールアドレス</label>
                <input
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleChange}
                />
                {errors.email && <span style={{ color: 'red' }}>{errors.email}</span>}
            </div>
            
            <div>
                <label>パスワード</label>
                <input
                    type="password"
                    name="password"
                    value={formData.password}
                    onChange={handleChange}
                />
                {errors.password && <span style={{ color: 'red' }}>{errors.password}</span>}
            </div>
            
            <button type="submit">送信</button>
            {isValid && <p style={{ color: 'green' }}>バリデーション成功！</p>}
        </form>
    );
}

export default UserForm;
```

### Zodの高度な機能

#### オプショナルフィールド

```jsx
const schema = z.object({
    name: z.string(),
    age: z.number().optional(), // オプショナル
    email: z.string().email().nullable() // null許可
});
```

#### カスタムバリデーション

```jsx
const schema = z.object({
    password: z.string(),
    confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
    message: "パスワードが一致しません",
    path: ["confirmPassword"]
});
```

#### 配列のバリデーション

```jsx
const schema = z.object({
    tags: z.array(z.string()).min(1, "少なくとも1つのタグが必要です")
});
```

---

## Yup を用いたバリデーション定義

### Yupとは
Yupは、**柔軟で強力なスキーマバリデーションライブラリ**です。JavaScriptとTypeScriptの両方で使用できます。

### Yupのインストール

```bash
npm install yup
```

### 基本的なスキーマ定義

```jsx
import * as yup from 'yup';

// 文字列のスキーマ
const stringSchema = yup.string();

// 数値のスキーマ
const numberSchema = yup.number();

// 真偽値のスキーマ
const booleanSchema = yup.boolean();
```

### オブジェクトスキーマの定義

```jsx
import * as yup from 'yup';

// ユーザースキーマの定義
const userSchema = yup.object({
    name: yup.string().required("名前は必須です"),
    age: yup.number().min(0, "年齢は0以上である必要があります"),
    email: yup.string().email("有効なメールアドレスを入力してください")
});
```

### バリデーションの実行

```jsx
import * as yup from 'yup';

const userSchema = yup.object({
    name: yup.string().required("名前は必須です"),
    age: yup.number().min(0),
    email: yup.string().email()
});

// バリデーションの実行（Promiseを返す）
userSchema.validate({
    name: "太郎",
    age: 25,
    email: "taro@example.com"
})
.then((data) => {
    console.log("バリデーション成功:", data);
})
.catch((error) => {
    console.log("エラー:", error.errors);
});

// または async/await
try {
    const data = await userSchema.validate({
        name: "太郎",
        age: 25,
        email: "taro@example.com"
    });
    console.log("バリデーション成功:", data);
} catch (error) {
    console.log("エラー:", error.errors);
}
```

### 実践例: Yupによるバリデーション

```jsx
// src/schemas/userSchema.js
import * as yup from 'yup';

// 基本的なユーザースキーマ
export const userSchema = yup.object({
    name: yup.string()
        .required("名前は必須です")
        .max(50, "名前は50文字以内で入力してください"),
    age: yup.number()
        .typeError("年齢は数値で入力してください")
        .min(0, "年齢は0以上である必要があります")
        .max(150, "年齢は150以下である必要があります"),
    email: yup.string()
        .required("メールアドレスは必須です")
        .email("有効なメールアドレスを入力してください"),
    password: yup.string()
        .required("パスワードは必須です")
        .min(8, "パスワードは8文字以上である必要があります")
        .matches(/[A-Z]/, "パスワードには大文字を含める必要があります")
        .matches(/[a-z]/, "パスワードには小文字を含める必要があります")
        .matches(/[0-9]/, "パスワードには数字を含める必要があります")
});

// src/components/UserForm.jsx
import React, { useState } from 'react';
import { userSchema } from '../schemas/userSchema';

function UserForm() {
    const [formData, setFormData] = useState({
        name: '',
        age: '',
        email: '',
        password: ''
    });
    const [errors, setErrors] = useState({});
    const [isValid, setIsValid] = useState(false);
    
    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: value
        }));
    };
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        try {
            // バリデーションの実行
            const validatedData = await userSchema.validate(formData, {
                abortEarly: false // すべてのエラーを取得
            });
            
            setIsValid(true);
            setErrors({});
            console.log('バリデーション成功:', validatedData);
            // フォーム送信処理
        } catch (error) {
            setIsValid(false);
            // エラーをオブジェクト形式に変換
            const errorMap = {};
            if (error.inner) {
                error.inner.forEach((err) => {
                    errorMap[err.path] = err.message;
                });
            }
            setErrors(errorMap);
        }
    };
    
    return (
        <form onSubmit={handleSubmit}>
            <div>
                <label>名前</label>
                <input
                    type="text"
                    name="name"
                    value={formData.name}
                    onChange={handleChange}
                />
                {errors.name && <span style={{ color: 'red' }}>{errors.name}</span>}
            </div>
            
            <div>
                <label>年齢</label>
                <input
                    type="number"
                    name="age"
                    value={formData.age}
                    onChange={handleChange}
                />
                {errors.age && <span style={{ color: 'red' }}>{errors.age}</span>}
            </div>
            
            <div>
                <label>メールアドレス</label>
                <input
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleChange}
                />
                {errors.email && <span style={{ color: 'red' }}>{errors.email}</span>}
            </div>
            
            <div>
                <label>パスワード</label>
                <input
                    type="password"
                    name="password"
                    value={formData.password}
                    onChange={handleChange}
                />
                {errors.password && <span style={{ color: 'red' }}>{errors.password}</span>}
            </div>
            
            <button type="submit">送信</button>
            {isValid && <p style={{ color: 'green' }}>バリデーション成功！</p>}
        </form>
    );
}

export default UserForm;
```

### Yupの高度な機能

#### 条件付きバリデーション

```jsx
const schema = yup.object({
    hasEmail: yup.boolean(),
    email: yup.string().when('hasEmail', {
        is: true,
        then: (schema) => schema.required("メールアドレスは必須です").email(),
        otherwise: (schema) => schema.notRequired()
    })
});
```

#### 配列のバリデーション

```jsx
const schema = yup.object({
    tags: yup.array()
        .of(yup.string())
        .min(1, "少なくとも1つのタグが必要です")
});
```

#### カスタムバリデーション

```jsx
const schema = yup.object({
    password: yup.string(),
    confirmPassword: yup.string().oneOf(
        [yup.ref('password')],
        "パスワードが一致しません"
    )
});
```

---

## React Hook Formとの連携

### React Hook Formとスキーマバリデーション

React Hook Formは、`@hookform/resolvers`パッケージを使って、ZodやYupのスキーマと連携できます。

### インストール

```bash
# Zodを使う場合
npm install @hookform/resolvers zod

# Yupを使う場合
npm install @hookform/resolvers yup
```

### ZodとReact Hook Formの連携

```jsx
// src/components/UserFormWithZod.jsx
import React from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

// スキーマの定義
const userSchema = z.object({
    name: z.string().min(1, "名前は必須です"),
    age: z.number().min(0, "年齢は0以上である必要があります"),
    email: z.string().email("有効なメールアドレスを入力してください")
});

function UserForm() {
    const {
        register,
        handleSubmit,
        formState: { errors }
    } = useForm({
        resolver: zodResolver(userSchema)
    });
    
    const onSubmit = (data) => {
        console.log('送信データ:', data);
    };
    
    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <div>
                <label>名前</label>
                <input {...register('name')} />
                {errors.name && <span style={{ color: 'red' }}>{errors.name.message}</span>}
            </div>
            
            <div>
                <label>年齢</label>
                <input type="number" {...register('age', { valueAsNumber: true })} />
                {errors.age && <span style={{ color: 'red' }}>{errors.age.message}</span>}
            </div>
            
            <div>
                <label>メールアドレス</label>
                <input type="email" {...register('email')} />
                {errors.email && <span style={{ color: 'red' }}>{errors.email.message}</span>}
            </div>
            
            <button type="submit">送信</button>
        </form>
    );
}

export default UserForm;
```

### YupとReact Hook Formの連携

```jsx
// src/components/UserFormWithYup.jsx
import React from 'react';
import { useForm } from 'react-hook-form';
import { yupResolver } from '@hookform/resolvers/yup';
import * as yup from 'yup';

// スキーマの定義
const userSchema = yup.object({
    name: yup.string().required("名前は必須です"),
    age: yup.number().min(0, "年齢は0以上である必要があります"),
    email: yup.string().email("有効なメールアドレスを入力してください")
});

function UserForm() {
    const {
        register,
        handleSubmit,
        formState: { errors }
    } = useForm({
        resolver: yupResolver(userSchema)
    });
    
    const onSubmit = (data) => {
        console.log('送信データ:', data);
    };
    
    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <div>
                <label>名前</label>
                <input {...register('name')} />
                {errors.name && <span style={{ color: 'red' }}>{errors.name.message}</span>}
            </div>
            
            <div>
                <label>年齢</label>
                <input type="number" {...register('age', { valueAsNumber: true })} />
                {errors.age && <span style={{ color: 'red' }}>{errors.age.message}</span>}
            </div>
            
            <div>
                <label>メールアドレス</label>
                <input type="email" {...register('email')} />
                {errors.email && <span style={{ color: 'red' }}>{errors.email.message}</span>}
            </div>
            
            <button type="submit">送信</button>
        </form>
    );
}

export default UserForm;
```

### 実践例: 複雑なフォームのバリデーション

```jsx
// src/components/ComplexForm.jsx
import React from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

// 複雑なスキーマの定義
const formSchema = z.object({
    name: z.string().min(1, "名前は必須です"),
    email: z.string().email("有効なメールアドレスを入力してください"),
    age: z.number().min(0).max(150),
    password: z.string()
        .min(8, "パスワードは8文字以上である必要があります")
        .regex(/[A-Z]/, "パスワードには大文字を含める必要があります"),
    confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
    message: "パスワードが一致しません",
    path: ["confirmPassword"]
});

function ComplexForm() {
    const {
        register,
        handleSubmit,
        formState: { errors }
    } = useForm({
        resolver: zodResolver(formSchema)
    });
    
    const onSubmit = (data) => {
        console.log('送信データ:', data);
    };
    
    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <div>
                <label>名前</label>
                <input {...register('name')} />
                {errors.name && <span style={{ color: 'red' }}>{errors.name.message}</span>}
            </div>
            
            <div>
                <label>メールアドレス</label>
                <input type="email" {...register('email')} />
                {errors.email && <span style={{ color: 'red' }}>{errors.email.message}</span>}
            </div>
            
            <div>
                <label>年齢</label>
                <input type="number" {...register('age', { valueAsNumber: true })} />
                {errors.age && <span style={{ color: 'red' }}>{errors.age.message}</span>}
            </div>
            
            <div>
                <label>パスワード</label>
                <input type="password" {...register('password')} />
                {errors.password && <span style={{ color: 'red' }}>{errors.password.message}</span>}
            </div>
            
            <div>
                <label>パスワード（確認）</label>
                <input type="password" {...register('confirmPassword')} />
                {errors.confirmPassword && <span style={{ color: 'red' }}>{errors.confirmPassword.message}</span>}
            </div>
            
            <button type="submit">送信</button>
        </form>
    );
}

export default ComplexForm;
```

---

## まとめ

この章では、スキーマバリデーション（Zod と Yup）について学びました。

### 学んだこと
- **スキーマバリデーション**: データの構造とルールを定義して検証する手法
- **Zod**: TypeScriptファーストのスキーマバリデーションライブラリ
- **Yup**: 柔軟で強力なスキーマバリデーションライブラリ
- **React Hook Formとの連携**: `@hookform/resolvers`を使った統合

### 重要なポイント
1. **型安全性**: Zodは型推論が強力で、TypeScriptと相性が良い
2. **再利用性**: スキーマを定義して複数の場所で使える
3. **保守性**: バリデーションルールを1箇所で管理できる
4. **統合**: React Hook Formと組み合わせて効率的にフォームを実装できる

### ZodとYupの使い分け
- **Zod**: TypeScriptプロジェクトで型安全性を重視する場合
- **Yup**: JavaScript/TypeScript両方で使え、柔軟なバリデーションが必要な場合

### 次のステップ
スキーマバリデーションを理解することで、型安全で保守しやすいフォームを実装できるようになります。次の章では、スタイリングとコンポーネント設計について詳しく学びます。

---

## 演習問題

### 問題1: Zodスキーマの定義
名前、メールアドレス、年齢をバリデーションするZodスキーマを作成してください。

<details>
<summary>解答例</summary>

```jsx
import { z } from 'zod';

const userSchema = z.object({
    name: z.string().min(1, "名前は必須です"),
    email: z.string().email("有効なメールアドレスを入力してください"),
    age: z.number().min(0, "年齢は0以上である必要があります")
});

// 使用例
const result = userSchema.safeParse({
    name: "太郎",
    email: "taro@example.com",
    age: 25
});
```
</details>

### 問題2: Yupスキーマの定義
名前、メールアドレス、年齢をバリデーションするYupスキーマを作成してください。

<details>
<summary>解答例</summary>

```jsx
import * as yup from 'yup';

const userSchema = yup.object({
    name: yup.string().required("名前は必須です"),
    email: yup.string().email("有効なメールアドレスを入力してください"),
    age: yup.number().min(0, "年齢は0以上である必要があります")
});

// 使用例
userSchema.validate({
    name: "太郎",
    email: "taro@example.com",
    age: 25
})
.then((data) => console.log("成功:", data))
.catch((error) => console.log("エラー:", error.errors));
```
</details>

### 問題3: React Hook FormとZodの連携
React Hook FormとZodを使って、名前とメールアドレスのフォームを作成してください。

<details>
<summary>解答例</summary>

```jsx
import React from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const formSchema = z.object({
    name: z.string().min(1, "名前は必須です"),
    email: z.string().email("有効なメールアドレスを入力してください")
});

function Form() {
    const {
        register,
        handleSubmit,
        formState: { errors }
    } = useForm({
        resolver: zodResolver(formSchema)
    });
    
    const onSubmit = (data) => {
        console.log('送信データ:', data);
    };
    
    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <div>
                <label>名前</label>
                <input {...register('name')} />
                {errors.name && <span>{errors.name.message}</span>}
            </div>
            
            <div>
                <label>メールアドレス</label>
                <input type="email" {...register('email')} />
                {errors.email && <span>{errors.email.message}</span>}
            </div>
            
            <button type="submit">送信</button>
        </form>
    );
}
```
</details>

### 問題4: パスワード確認のバリデーション
Zodを使って、パスワードと確認パスワードが一致することを検証するスキーマを作成してください。

<details>
<summary>解答例</summary>

```jsx
import { z } from 'zod';

const passwordSchema = z.object({
    password: z.string().min(8, "パスワードは8文字以上である必要があります"),
    confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
    message: "パスワードが一致しません",
    path: ["confirmPassword"]
});

// 使用例
const result = passwordSchema.safeParse({
    password: "password123",
    confirmPassword: "password123"
});
```
</details>

### 問題5: 条件付きバリデーション
Yupを使って、チェックボックスが選択されている場合のみメールアドレスを必須にするスキーマを作成してください。

<details>
<summary>解答例</summary>

```jsx
import * as yup from 'yup';

const formSchema = yup.object({
    hasEmail: yup.boolean(),
    email: yup.string().when('hasEmail', {
        is: true,
        then: (schema) => schema.required("メールアドレスは必須です").email(),
        otherwise: (schema) => schema.notRequired()
    })
});

// 使用例
formSchema.validate({
    hasEmail: true,
    email: "taro@example.com"
})
.then((data) => console.log("成功:", data))
.catch((error) => console.log("エラー:", error.errors));
```
</details>

---

お疲れ様でした！次の章に進みましょう。


